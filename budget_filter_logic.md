# 予算帯フィルタの仕組み（詳細仕様）

## 1. 概要
ユーザーが選択した「予算（下限〜上限）」に基づいて、対象となる店舗をフィルタリングする仕組みです。
当初は HotPepper API の `budget` パラメータを使用していましたが、API仕様との相性問題（特定のコード指定で0件になる等）および一部店舗（コード未設定）への対応のため、現在は**全件取得後のテキスト解析によるクライアントサイドフィルタリング**を採用しています。

## 2. 処理フロー

### ① ユーザー入力の取得
UIで以下の入力が行われます。
- **モード**: ランチ or ディナー
- **予算下限**: 例「2000円」（未指定時は0）
- **予算上限**: 例「5000円」（未指定時は無限大）

### ② 店舗データの取得（APIリクエスト）
HotPepper API に対するリクエストでは、**予算による絞り込みを行いません**。
- `fetchShops` 関数に `budgetCodes=[]`（空配列）を渡します。
- これにより、APIは指定されたジャンル・エリア内の店舗を、予算に関係なく最大100件取得します。
- **目的**: APIのパラメータ制限や不具合を回避し、確実に店舗データを取得するため。

### ③ クライアントサイドでのフィルタリング（テキスト解析）
取得した店舗データ（`shops` 配列）に対して、アプリ内（`searchShops` 関数）で以下の判定ロジックを実行します。

#### 【共通ロジック（ランチ・ディナー）】
- **判定対象**: 
  - ランチモード: `lunch` フィールド（例："900円"）
  - ディナーモード: `budget` フィールド（例："2001～3000円"） または `budgetAverage`（例："2000円"）
- **アルゴリズム**:
    1. 対象フィールドのテキストから正規表現 `(\d{1,3}(?:,\d{3})*)` で最初の数値を抽出。
       - 例: "2001～3000円" → `2001`
    2. 抽出した数値（予算帯の下限または代表値）が、ユーザー指定の予算範囲（`strictMinPrice` 〜 `strictMaxPrice`）に収まっているか判定。
       - 例: ユーザー上限5000円、店舗2001円 → `2001 <= 5000` (OK)
    3. テキスト情報がない場合は「通過」とする（緩いフィルタ）。

## 3. この方式のメリット
- **確実性**: APIの仕様変更やパラメータ制限の影響を受けず、期待した店舗が確実にヒットします。
- **柔軟性**: 「〜500円」「B010」といったコード体系に依存せず、画面に表示される金額情報そのものに基づいて判定するため、直感的でズレがありません。
- **堅牢性**: APIデータに不備（コード未設定など）があっても、テキスト情報があれば救済できます。
