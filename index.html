<!DOCTYPE html>
<html lang="ja">

<head>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y5P8DCKR9V"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-Y5P8DCKR9V');
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ã‚°ãƒ«ã‚­ãƒ¡ï¼ - é‹å‘½ã®ã‚´ãƒãƒ³ã€å›ã—ã¦æ±ºã‚ã‚ˆã†ï¼</title>
    <meta name="description" content="ä½•é£Ÿã¹ã‚‹ï¼Ÿã§æ‚©ã‚“ã ã‚‰ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã§å³æ±ºï¼å‘¨è¾ºã®é£²é£Ÿåº—ã‹ã‚‰é‹å‘½ã®ä¸€é£Ÿã‚’æ±ºã‚ã‚ˆã†ã€‚" />

    <!-- ===== LinkSwitch ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼ˆãƒãƒªãƒ¥ãƒ¼ã‚³ãƒãƒ¼ã‚¹åç›ŠåŒ–ç”¨ï¼‰ ===== -->
    <!-- <script type="text/javascript" src="//tag.valuecommerce.com/linkswitch.js"></script> -->

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FFAB40',
                        accent: '#212121',
                        surface: '#FAFAFA',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                },
            },
        };
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap"
        rel="stylesheet" />

    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #FAFAFA;
            -webkit-tap-highlight-color: transparent;
        }

        /* ---------- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ ---------- */
        #roulette-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #roulette-canvas {
            border-radius: 50%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, .15);
        }

        /* ä¸‰è§’ã®ãƒã‚¤ãƒ³ã‚¿ãƒ¼ */
        .pointer {
            position: absolute;
            top: -14px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 14px solid transparent;
            border-right: 14px solid transparent;
            border-top: 28px solid #212121;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, .3));
            z-index: 10;
        }

        /* ---------- START ãƒœã‚¿ãƒ³ ---------- */
        .btn-start {
            background: linear-gradient(135deg, #FFAB40 0%, #FF8F00 100%);
            color: #fff;
            font-weight: 800;
            font-size: 1.25rem;
            letter-spacing: .05em;
            border: none;
            border-radius: 9999px;
            padding: .9rem 3rem;
            box-shadow: 0 6px 20px rgba(255, 171, 64, .45);
            cursor: pointer;
            transition: transform .15s, box-shadow .15s;
            -webkit-user-select: none;
            user-select: none;
        }

        .btn-start:active {
            transform: scale(.95);
            box-shadow: 0 3px 10px rgba(255, 171, 64, .3);
        }

        .btn-start:disabled {
            opacity: .5;
            cursor: not-allowed;
        }

        /* ---------- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ ---------- */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #E0E0E0;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            background: #FFAB40;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .2);
            cursor: pointer;
        }

        /* ---------- çµæœãƒ¢ãƒ¼ãƒ€ãƒ« ---------- */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .55);
            backdrop-filter: blur(6px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity .3s;
        }

        .modal-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-card {
            background: #fff;
            border-radius: 1.5rem;
            padding: 2rem 1.5rem;
            max-width: 360px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, .25);
            transform: translateY(30px);
            transition: transform .3s;
        }

        .modal-backdrop.active .modal-card {
            transform: translateY(0);
        }

        /* ---------- é›‘å¤š ---------- */
        .chip {
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            background: #FFF3E0;
            color: #E65100;
            padding: .3rem .75rem;
            border-radius: 9999px;
            font-size: .75rem;
            font-weight: 600;
        }

        .fade-in {
            animation: fadeIn .4s ease both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* è¿½åŠ å…¥åŠ› */
        .add-input {
            border: 2px dashed #FFAB40;
            border-radius: .75rem;
            padding: .5rem .75rem;
            outline: none;
            font-size: .875rem;
            width: 100%;
            transition: border-color .2s;
        }

        .add-input:focus {
            border-color: #FF8F00;
        }

        /* ---------- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒãƒ« ---------- */
        .filter-panel {
            border: 1px solid #F0F0F0;
            border-radius: 1rem;
            overflow: hidden;
            transition: max-height .3s ease;
        }

        .filter-toggle {
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
        }

        .filter-toggle .arrow {
            transition: transform .2s;
        }

        .filter-toggle.open .arrow {
            transform: rotate(180deg);
        }

        .genre-chip {
            display: inline-flex;
            align-items: center;
            gap: .25rem;
            padding: .35rem .7rem;
            border-radius: 9999px;
            font-size: .75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .15s;
            border: 2px solid #E0E0E0;
            background: #fff;
            color: #616161;
        }

        .genre-chip.excluded {
            border-color: #EF5350;
            background: #FFEBEE;
            color: #C62828;
            text-decoration: line-through;
        }

        .budget-select {
            appearance: none;
            -webkit-appearance: none;
            background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M6 8L1 3h10z' fill='%23666'/%3E%3C/svg%3E") no-repeat right .75rem center;
            border: 2px solid #E0E0E0;
            border-radius: .75rem;
            padding: .5rem 2rem .5rem .75rem;
            font-size: .875rem;
            outline: none;
            transition: border-color .2s;
            width: 100%;
        }

        .budget-select:focus {
            border-color: #FFAB40;
        }

        .btn-search {
            background: linear-gradient(135deg, #42A5F5 0%, #1E88E5 100%);
            color: #fff;
            font-weight: 700;
            font-size: .875rem;
            border: none;
            border-radius: 9999px;
            padding: .6rem 1.5rem;
            box-shadow: 0 4px 12px rgba(66, 165, 245, .35);
            cursor: pointer;
            transition: transform .15s, box-shadow .15s;
        }

        .btn-search:active {
            transform: scale(.95);
        }

        .btn-search:disabled {
            opacity: .5;
            cursor: not-allowed;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== -->
    <header class="px-4 pt-1 pb-2 flex flex-col items-center justify-center sticky top-0 z-50"
        style="background:#FAFAFA;">
        <img src="logo.svg" alt="ãƒ¡ã‚·ã‚¬ãƒãƒ£" style="height:44px; object-fit:contain;" />
        <p class="text-xs text-gray-500 mt-1">é‹å‘½ã®ã‚´ãƒãƒ³ã€å›ã—ã¦æ±ºã‚ã‚ˆã†ï¼</p>
    </header>

    <!-- ===== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ===== -->
    <main class="flex-1 flex flex-col items-center px-4 pb-8">


        <!-- ===== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒãƒ« ===== -->
        <section class="w-full max-w-md mt-2 mb-3 filter-panel bg-white shadow-sm fade-in">
            <div id="filter-toggle" class="filter-toggle flex items-center justify-between px-4 py-3">
                <h2 class="text-sm font-bold text-accent flex items-center gap-2">ğŸ” åº—èˆ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h2>
                <span class="arrow text-gray-400 text-xs">â–¼</span>
            </div>
            <div id="filter-body" class="px-4 pb-4" style="display:none;">
                <!-- ã‚¸ãƒ£ãƒ³ãƒ«é™¤å¤– -->
                <p class="text-xs text-gray-400 font-semibold mb-2">é™¤å¤–ã™ã‚‹ã‚¸ãƒ£ãƒ³ãƒ«ï¼ˆã‚¿ãƒƒãƒ—ã§é™¤å¤–ï¼‰</p>
                <div id="genre-chips" class="flex flex-wrap gap-2 mb-4"></div>

                <!-- è·é›¢ -->
                <p class="text-xs text-gray-400 font-semibold mb-2">ğŸ“ ç¾åœ¨åœ°ã‹ã‚‰ã®è·é›¢</p>
                <select id="distance-range" class="budget-select mb-4">
                    <option value="1">300mä»¥å†…</option>
                    <option value="2">500mä»¥å†…</option>
                    <option value="3" selected>1kmä»¥å†…</option>
                    <option value="4">2kmä»¥å†…</option>
                    <option value="5">3kmä»¥å†…</option>
                </select>

                <!-- äºˆç®—å¸¯ -->
                <p class="text-xs text-gray-400 font-semibold mb-2">ğŸ’° äºˆç®—å¸¯</p>
                <div class="flex gap-2 mb-4">
                    <select id="budget-min" class="budget-select flex-1">
                        <option value="">ä¸‹é™ãªã—</option>
                    </select>
                    <span class="self-center text-gray-400 text-sm font-bold">ã€œ</span>
                    <select id="budget-max" class="budget-select flex-1">
                        <option value="">ä¸Šé™ãªã—</option>
                    </select>
                </div>

                <!-- å–¶æ¥­ä¸­ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="flex items-center gap-2 mb-4">
                    <label class="flex items-center gap-2 cursor-pointer text-sm font-semibold text-accent">
                        <input type="checkbox" id="filter-open-now" class="w-5 h-5 rounded accent-primary" />
                        ğŸŸ¢ å–¶æ¥­ä¸­ã®åº—èˆ—ã®ã¿è¡¨ç¤º
                    </label>
                </div>

                <!-- å†æ¤œç´¢ãƒœã‚¿ãƒ³ -->
                <button id="btn-research" class="btn-search w-full">ğŸ”„ ã“ã®æ¡ä»¶ã§å†æ¤œç´¢</button>
            </div>
        </section>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <div id="status-bar" class="w-full max-w-md mb-2 text-center text-sm text-gray-500 fade-in">
            ğŸ“ ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™â€¦
        </div>

        <!-- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ -->
        <section id="roulette-container" class="my-4">
            <div class="pointer"></div>
            <canvas id="roulette-canvas" width="300" height="300"></canvas>
        </section>

        <!-- START ãƒœã‚¿ãƒ³ -->
        <button id="btn-start" class="btn-start mt-2 mb-6" disabled>START</button>

        <!-- ===== è¨­å®šãƒ‘ãƒãƒ« ===== -->
        <section id="settings-panel" class="w-full max-w-md bg-white rounded-2xl shadow-md p-5 space-y-5 fade-in">
            <h2 class="text-base font-bold text-accent flex items-center gap-2">âš™ï¸ é¸æŠè‚¢ & ç¢ºç‡è¨­å®š</h2>

            <!-- é¸æŠè‚¢ãƒªã‚¹ãƒˆï¼ˆå‹•çš„ç”Ÿæˆï¼‰ -->
            <div id="choices-list" class="space-y-3"></div>

            <!-- ã‚«ã‚¹ã‚¿ãƒ é¸æŠè‚¢è¿½åŠ  -->
            <div class="pt-2 border-t border-gray-100">
                <p class="text-xs text-gray-400 mb-2 font-semibold">ï¼‹ ã‚«ã‚¹ã‚¿ãƒ é¸æŠè‚¢ã‚’è¿½åŠ </p>
                <div class="flex gap-2">
                    <input id="custom-input" type="text" class="add-input flex-1" placeholder="ä¾‹ï¼šãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰"
                        maxlength="20" />
                    <button id="btn-add-custom"
                        class="bg-primary text-accent font-bold px-4 py-2 rounded-xl text-sm shadow hover:shadow-md transition">è¿½åŠ </button>
                </div>
            </div>
        </section>
    </main>

    <!-- ===== ãƒ•ãƒƒã‚¿ãƒ¼ ===== -->
    <footer class="py-4 text-center text-xs text-gray-400" style="background:#FAFAFA;">
        <a href="http://webservice.recruit.co.jp/" target="_blank" rel="noopener">
            <img src="https://webservice.recruit.co.jp/banner/hotpepper-s.gif" alt="Powered by ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ Webã‚µãƒ¼ãƒ“ã‚¹"
                style="height:16px; display:inline-block; vertical-align:middle;" />
        </a>
        <p class="mt-1">Powered by <a href="http://webservice.recruit.co.jp/" target="_blank" rel="noopener"
                class="text-gray-400 underline">ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ Webã‚µãƒ¼ãƒ“ã‚¹</a></p>
    </footer>

    <!-- ===== çµæœãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
    <div id="result-modal" class="modal-backdrop">
        <div class="modal-card">
            <div id="result-emoji" class="text-5xl mb-3">ğŸ‰</div>
            <h3 id="result-title" class="text-xl font-extrabold text-accent mb-1"></h3>
            <p id="result-sub" class="text-sm text-gray-500 mb-4"></p>
            <img id="result-img" class="w-full rounded-xl mb-4 hidden" alt="åº—èˆ—ç”»åƒ" />
            <a id="result-action" href="#" target="_blank" rel="noopener"
                class="inline-block bg-primary text-white font-bold px-6 py-3 rounded-full shadow-lg text-sm mb-3 hover:shadow-xl transition">
            </a>
            <br />
            <!-- ãƒªãƒˆãƒ©ã‚¤ï¼ˆå°†æ¥çš„ã«åºƒå‘Šã‚’æŒŸã‚ã‚‹è¨­è¨ˆï¼‰ -->
            <!-- ã“ã“ã«åºƒå‘Šã‚¹ãƒ­ãƒƒãƒˆã‚’æŒ¿å…¥å¯èƒ½ -->
            <button id="btn-retry" class="mt-2 text-gray-400 underline text-sm hover:text-accent transition">ğŸ”„
                ã‚‚ã†ä¸€å›å›ã™</button>
        </div>
    </div>

    <!-- ============================= JavaScript ============================= -->
    <script>
        // =====================================================================
        //  è¨­å®š
        // =====================================================================
        const IS_DEBUG = false; // true: ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ‰ / false: æœ¬ç•ªï¼ˆãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼APIï¼‰

        // â˜…æœ¬ç•ªæ™‚ã¯ã“ã“ã«APIã‚­ãƒ¼ã‚’è¨­å®š
        const HP_API_KEY = 'f008a1b21c675ccc';

        // =====================================================================
        //  ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
        // =====================================================================
        const MOCK_SHOPS = [
            { name: 'ç„¼è‚‰ã‚­ãƒ³ã‚° æ¸‹è°·åº—', catch: 'é£Ÿã¹æ”¾é¡ŒãŒå¤§äººæ°—ï¼', genre: 'ç„¼è‚‰', photo: '', url: 'https://www.hotpepper.jp/' },
            { name: 'ã‚¹ã‚·ãƒ­ãƒ¼ æ–°å®¿æ±å£åº—', catch: 'å›è»¢å¯¿å¸ãªã‚‰ã“ã“', genre: 'å¯¿å¸', photo: '', url: 'https://www.hotpepper.jp/' },
            { name: 'ã‚µã‚¤ã‚¼ãƒªãƒ¤ æ± è¢‹åº—', catch: 'ã‚³ã‚¹ãƒ‘æœ€å¼·ã‚¤ã‚¿ãƒªã‚¢ãƒ³', genre: 'ã‚¤ã‚¿ãƒªã‚¢ãƒ³', photo: '', url: 'https://www.hotpepper.jp/' },
            { name: 'CoCoå£±ç•ªå±‹ ç›®é»’åº—', catch: 'ã‚«ãƒ¬ãƒ¼ã®ç‹é“', genre: 'ã‚«ãƒ¬ãƒ¼', photo: '', url: 'https://www.hotpepper.jp/' },
            { name: 'å¤©ä¸‹ä¸€å“ å…­æœ¬æœ¨åº—', catch: 'ã“ã£ã¦ã‚Šãƒ©ãƒ¼ãƒ¡ãƒ³', genre: 'ãƒ©ãƒ¼ãƒ¡ãƒ³', photo: '', url: 'https://www.hotpepper.jp/' },
            { name: 'å¤§æˆ¸å±‹ å“å·åº—', catch: 'ã¡ã‚ƒã‚“ã¨ã‚´ãƒãƒ³', genre: 'å’Œé£Ÿ', photo: '', url: 'https://www.hotpepper.jp/' },
            { name: 'ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰ æ±äº¬é§…åº—', catch: 'ã‚¹ãƒã‚¤ãƒ«0å††ï¼', genre: 'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰', photo: '', url: 'https://www.hotpepper.jp/' },
            { name: 'é³¥è²´æ— æµæ¯”å¯¿åº—', catch: 'å…¨å“å‡ä¸€ä¾¡æ ¼ï¼', genre: 'å±…é…’å±‹', photo: '', url: 'https://www.hotpepper.jp/' },
        ];

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ã‚¹ã‚¿ãƒ é¸æŠè‚¢
        const DEFAULT_CUSTOM = [
            { name: 'ã‚³ãƒ³ãƒ“ãƒ‹', emoji: 'ğŸª' },
            { name: 'è‡ªç‚Š', emoji: 'ğŸ³' },
            { name: 'æ–­é£Ÿï¼ˆé£Ÿã¹ãªã„ï¼‰', emoji: 'ğŸ§˜' },
        ];

        // ã‚¸ãƒ£ãƒ³ãƒ«ãƒã‚¹ã‚¿
        const GENRES = [
            { code: 'G001', name: 'å±…é…’å±‹', emoji: 'ğŸ¶' },
            { code: 'G002', name: 'ãƒ€ã‚¤ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒ»ãƒãƒ«', emoji: 'ğŸ·' },
            { code: 'G003', name: 'å‰µä½œæ–™ç†', emoji: 'ğŸ¨' },
            { code: 'G004', name: 'å’Œé£Ÿ', emoji: 'ğŸ£' },
            { code: 'G005', name: 'æ´‹é£Ÿ', emoji: 'ğŸ' },
            { code: 'G006', name: 'ã‚¤ã‚¿ãƒªã‚¢ãƒ³ãƒ»ãƒ•ãƒ¬ãƒ³ãƒ', emoji: 'ğŸ‡®ğŸ‡¹' },
            { code: 'G007', name: 'ä¸­è¯', emoji: 'ğŸ¥Ÿ' },
            { code: 'G008', name: 'ç„¼è‚‰ãƒ»ãƒ›ãƒ«ãƒ¢ãƒ³', emoji: 'ğŸ¥©' },
            { code: 'G017', name: 'éŸ“å›½æ–™ç†', emoji: 'ğŸ‡°ğŸ‡·' },
            { code: 'G009', name: 'ã‚¢ã‚¸ã‚¢ãƒ»ã‚¨ã‚¹ãƒ‹ãƒƒã‚¯', emoji: 'ğŸ›' },
            { code: 'G010', name: 'å„å›½æ–™ç†', emoji: 'ğŸŒ' },
            { code: 'G011', name: 'ã‚«ãƒ©ã‚ªã‚±ãƒ»ãƒ‘ãƒ¼ãƒ†ã‚£', emoji: 'ğŸ¤' },
            { code: 'G012', name: 'ãƒãƒ¼ãƒ»ã‚«ã‚¯ãƒ†ãƒ«', emoji: 'ğŸ¸' },
            { code: 'G013', name: 'ãƒ©ãƒ¼ãƒ¡ãƒ³', emoji: 'ğŸœ' },
            { code: 'G016', name: 'ãŠå¥½ã¿ç„¼ããƒ»ã‚‚ã‚“ã˜ã‚ƒ', emoji: 'ğŸ¥' },
            { code: 'G014', name: 'ã‚«ãƒ•ã‚§ãƒ»ã‚¹ã‚¤ãƒ¼ãƒ„', emoji: 'â˜•' },
            { code: 'G015', name: 'ãã®ä»–ã‚°ãƒ«ãƒ¡', emoji: 'ğŸ´' },
        ];

        // äºˆç®—ãƒã‚¹ã‚¿ï¼ˆå®‰ã„é †ï¼‰
        const BUDGETS = [
            { code: 'B009', name: 'ã€œ500å††' },
            { code: 'B010', name: '501ã€œ1000å††' },
            { code: 'B011', name: '1001ã€œ1500å††' },
            { code: 'B001', name: '1501ã€œ2000å††' },
            { code: 'B002', name: '2001ã€œ3000å††' },
            { code: 'B003', name: '3001ã€œ4000å††' },
            { code: 'B008', name: '4001ã€œ5000å††' },
            { code: 'B004', name: '5001ã€œ7000å††' },
            { code: 'B005', name: '7001ã€œ10000å††' },
            { code: 'B006', name: '10001ã€œ15000å††' },
            { code: 'B012', name: '15001ã€œ20000å††' },
            { code: 'B013', name: '20001ã€œ30000å††' },
            { code: 'B014', name: '30001å††ã€œ' },
        ];

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹
        let excludedGenres = new Set(); // é™¤å¤–ã™ã‚‹ã‚¸ãƒ£ãƒ³ãƒ«ã‚³ãƒ¼ãƒ‰
        let userLocation = null;        // { lat, lng }

        // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
        const PALETTE = [
            '#FFAB40', '#FF7043', '#AB47BC', '#42A5F5', '#66BB6A',
            '#FFEE58', '#EF5350', '#26C6DA', '#8D6E63', '#78909C',
            '#EC407A', '#7E57C2', '#29B6F6', '#9CCC65', '#FFA726',
        ];

        // =====================================================================
        //  State
        // =====================================================================
        let choices = [];   // { id, name, type:'shop'|'custom', weight, enabled, data? }
        let spinning = false;
        let idCounter = 0;

        // DOM
        const canvas = document.getElementById('roulette-canvas');
        const ctx = canvas.getContext('2d');
        const btnStart = document.getElementById('btn-start');
        const choicesList = document.getElementById('choices-list');
        const statusBar = document.getElementById('status-bar');
        const modal = document.getElementById('result-modal');
        const customInput = document.getElementById('custom-input');
        const btnAdd = document.getElementById('btn-add-custom');

        // HiDPI
        const dpr = window.devicePixelRatio || 1;
        const SIZE = 300;
        canvas.width = SIZE * dpr;
        canvas.height = SIZE * dpr;
        canvas.style.width = SIZE + 'px';
        canvas.style.height = SIZE + 'px';
        ctx.scale(dpr, dpr);

        // =====================================================================
        //  åˆæœŸåŒ–
        // =====================================================================
        async function init() {
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UIã‚’åˆæœŸåŒ–
            initFilterUI();

            try {
                if (IS_DEBUG) {
                    statusBar.textContent = 'ğŸ› ï¸ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰';
                    loadShops(MOCK_SHOPS);
                } else {
                    statusBar.textContent = 'ğŸ“ ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™â€¦';
                    const pos = await getLocation();
                    userLocation = pos;
                    await searchShops();
                }
            } catch (e) {
                console.error(e);
                statusBar.textContent = 'âš ï¸ ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';
            }

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ã‚¹ã‚¿ãƒ é¸æŠè‚¢
            DEFAULT_CUSTOM.forEach(c => {
                addChoice(c.name, 'custom', 5, false, { emoji: c.emoji });
            });

            renderChoicesUI();
            drawRoulette();
            btnStart.disabled = false;
        }

        // åº—èˆ—æ¤œç´¢ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ï¼‰
        async function searchShops() {
            statusBar.textContent = 'å‘¨è¾ºã®é£²é£Ÿåº—ã‚’æ¤œç´¢ä¸­â€¦';
            btnStart.disabled = true;

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’åé›†
            const budgetMin = document.getElementById('budget-min').value;
            const budgetMax = document.getElementById('budget-max').value;
            const includedGenres = GENRES
                .filter(g => !excludedGenres.has(g.code))
                .map(g => g.code);

            // äºˆç®—ã‚³ãƒ¼ãƒ‰ã®ç¯„å›²ã‚’ãƒªã‚¹ãƒˆã§å–å¾—
            let budgetCodes = [];
            if (budgetMin || budgetMax) {
                const minIdx = budgetMin ? BUDGETS.findIndex(b => b.code === budgetMin) : 0;
                const maxIdx = budgetMax ? BUDGETS.findIndex(b => b.code === budgetMax) : BUDGETS.length - 1;
                budgetCodes = BUDGETS.slice(minIdx, maxIdx + 1).map(b => b.code);
            }

            const rangeVal = document.getElementById('distance-range').value;

            const openNowChecked = document.getElementById('filter-open-now').checked;

            try {
                let shops = await fetchShops(userLocation.lat, userLocation.lng, includedGenres, budgetCodes, rangeVal, openNowChecked);

                // ã‚¸ãƒ£ãƒ³ãƒ«é™¤å¤–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆAPIå´ã§æ¼ã‚Œã‚‹ã‚µãƒ–ã‚¸ãƒ£ãƒ³ãƒ«ç™»éŒ²ã®åº—èˆ—ã‚’é™¤å¤–ï¼‰
                if (excludedGenres.size > 0) {
                    shops = shops.filter(s => !excludedGenres.has(s.genreCode));
                }

                // å–¶æ¥­ä¸­ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒ†ã‚­ã‚¹ãƒˆè§£æï¼‰
                if (openNowChecked) {
                    const filtered = shops.filter(s => isOpenNow(s));
                    shops = filtered;
                }

                // æ—¢å­˜ã®åº—èˆ—é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
                choices = choices.filter(c => c.type !== 'shop');
                const pickCount = loadShops(shops);
                renderChoicesUI();
                drawRoulette();
                statusBar.textContent = `ğŸ“ å‘¨è¾º ${shops.length} åº—èˆ—ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ${pickCount}åº—èˆ—ã‚’é¸å‡º`;
            } catch (e) {
                console.error(e);
                if (choices.filter(c => c.type === 'shop').length === 0) {
                    statusBar.textContent = 'âš ï¸ è©²å½“åº—èˆ—ãªã—ã€‚æ¡ä»¶ã‚’ç·©ã‚ã¦ã¿ã¦ãã ã•ã„ã€‚';
                    loadShops(MOCK_SHOPS);
                    renderChoicesUI();
                    drawRoulette();
                }
            }
            btnStart.disabled = false;
        }

        // =====================================================================
        //  Geolocation
        // =====================================================================
        function getLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) return reject('Geolocation not supported');
                navigator.geolocation.getCurrentPosition(
                    pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
                    err => reject(err),
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            });
        }

        // =====================================================================
        //  ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼APIï¼ˆfetch + CORSãƒ—ãƒ­ã‚­ã‚·ï¼‰
        // =====================================================================
        async function fetchShops(lat, lng, genreCodes = [], budgetCodes = [], range = '3', openNow = false) {
            let params = `key=${HP_API_KEY}&lat=${lat}&lng=${lng}&range=${range}&count=100&format=json`;

            // ã‚¸ãƒ£ãƒ³ãƒ«æŒ‡å®šï¼ˆAPIã¯ genre ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§è¤‡æ•°æŒ‡å®šå¯èƒ½ï¼‰
            if (genreCodes.length > 0 && genreCodes.length < GENRES.length) {
                params += `&genre=${genreCodes.join(',')}`;
            }
            // äºˆç®—æŒ‡å®šï¼ˆè¤‡æ•°äºˆç®—ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ï¼‰
            if (budgetCodes.length > 0) {
                params += `&budget=${budgetCodes.join(',')}`;
            }
            // ç¬¬1å±¤: å–¶æ¥­ä¸­ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆAPIå´ã§å¤§ã¾ã‹ã«çµã‚‹ï¼‰
            if (openNow) {
                const hour = new Date().getHours();
                if (hour >= 11 && hour < 14) params += '&lunch=1';
                if (hour >= 23 || hour < 5) params += '&midnight=1';
            }

            const baseUrl = `https://webservice.recruit.co.jp/hotpepper/gourmet/v1/?${params}`;

            // CORSãƒ—ãƒ­ã‚­ã‚·ã®ãƒªã‚¹ãƒˆï¼ˆé †ç•ªã«è©¦è¡Œï¼‰
            const proxyUrls = [
                `https://corsproxy.io/?${encodeURIComponent(baseUrl)}`,
                `https://api.allorigins.win/raw?url=${encodeURIComponent(baseUrl)}`,
                baseUrl,
            ];

            for (const url of proxyUrls) {
                try {
                    const controller = new AbortController();
                    const timer = setTimeout(() => controller.abort(), 8000);

                    const res = await fetch(url, { signal: controller.signal });
                    clearTimeout(timer);

                    if (!res.ok) continue;

                    const data = await res.json();
                    if (data.results && data.results.shop && data.results.shop.length > 0) {
                        return data.results.shop.map(s => ({
                            name: s.name,
                            catch: s.catch || '',
                            genre: s.genre ? s.genre.name : '',
                            genreCode: s.genre ? s.genre.code : '',
                            photo: s.photo && s.photo.pc ? s.photo.pc.l : '',
                            url: s.urls ? s.urls.pc : '',
                            budget: s.budget ? s.budget.name : '',
                            open: s.open || '',
                            close: s.close || '',
                        }));
                    }
                } catch (e) {
                    console.warn('API proxy failed:', url, e.message);
                    continue;
                }
            }
            throw new Error('All API attempts failed');
        }

        // =====================================================================
        //  å–¶æ¥­ä¸­åˆ¤å®šï¼ˆç¬¬2å±¤: å®šä¼‘æ—¥ + ç¬¬3å±¤: ãƒ†ã‚­ã‚¹ãƒˆè§£æï¼‰
        // =====================================================================
        function isOpenNow(shop) {
            if (!shop.open) return false; // ãƒ‡ãƒ¼ã‚¿ãªã—ã¯é™¤å¤–ï¼ˆå®‰å…¨å´ï¼‰

            const now = new Date();
            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const today = dayNames[now.getDay()];
            const nowMin = now.getHours() * 60 + now.getMinutes();

            // ç¬¬2å±¤: å®šä¼‘æ—¥ãƒã‚§ãƒƒã‚¯
            if (shop.close && shop.close !== 'ãªã—') {
                if (shop.close.includes(today)) return false;
            }

            // ç¬¬3å±¤: å–¶æ¥­æ™‚é–“ãƒ†ã‚­ã‚¹ãƒˆè§£æ
            // æ›œæ—¥ãƒ–ãƒ­ãƒƒã‚¯ã«åˆ†å‰²ã—ã¦ã€ä»Šæ—¥ã«è©²å½“ã™ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç‰¹å®š
            const text = shop.open;
            const todayBlock = extractTodayBlock(text, today);

            // ä»Šæ—¥ã®ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰æ™‚é–“ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡º
            const targetText = todayBlock || text; // ãƒ–ãƒ­ãƒƒã‚¯ç‰¹å®šã§ããªã‘ã‚Œã°å…¨ä½“
            const timePattern = /(\d{1,2}):(\d{2})\s*[ï½ã€œ~]\s*(?:ç¿Œ)?\s*(\d{1,2}):(\d{2})/g;
            let match;
            let hasTimeData = false;

            while ((match = timePattern.exec(targetText)) !== null) {
                hasTimeData = true;
                let openMin = parseInt(match[1]) * 60 + parseInt(match[2]);
                let closeMin = parseInt(match[3]) * 60 + parseInt(match[4]);

                // æ·±å¤œè·¨ãå¯¾å¿œï¼ˆç¿Œ0:00 ã‚„ 25:00 ãªã©ï¼‰
                if (closeMin <= openMin) closeMin += 24 * 60;
                let checkMin = nowMin;
                if (checkMin < openMin && openMin > 12 * 60) checkMin += 24 * 60;

                if (checkMin >= openMin && checkMin <= closeMin) return true;
            }

            // æ™‚é–“ãƒ‡ãƒ¼ã‚¿ãŒãƒ‘ãƒ¼ã‚¹ã§ããŸ â†’ ç¯„å›²å¤–ãªã®ã§å–¶æ¥­å¤–
            // æ™‚é–“ãƒ‡ãƒ¼ã‚¿ãŒãƒ‘ãƒ¼ã‚¹ã§ããªã‹ã£ãŸ â†’ åˆ¤å®šä¸èƒ½ãªã®ã§é™¤å¤–ï¼ˆå®‰å…¨å´ï¼‰
            return false;
        }

        // æ›œæ—¥ãƒ–ãƒ­ãƒƒã‚¯æŠ½å‡º: "æœˆï½é‡‘: 11:00ï½14:00 ... åœŸ: 18:00ï½22:00" â†’ ä»Šæ—¥ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿”ã™
        function extractTodayBlock(text, today) {
            // æ›œæ—¥ç¯„å›²ãƒ‘ã‚¿ãƒ¼ãƒ³: "æœˆï½é‡‘" "ç«ï½åœŸ" "æœˆï½æ—¥" ãªã©
            const dayOrder = 'æœˆç«æ°´æœ¨é‡‘åœŸæ—¥';
            const todayIdx = dayOrder.indexOf(today);
            if (todayIdx === -1) return null;

            // ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›œæ—¥ãƒ–ãƒ­ãƒƒã‚¯ã«åˆ†å‰²ï¼ˆã€Œæœˆï½é‡‘ã€ç¥å‰æ—¥:ã€ã®ã‚ˆã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã§åŒºåˆ‡ã‚‹ï¼‰
            const blockPattern = /([æœˆç«æ°´æœ¨é‡‘åœŸæ—¥](?:[ï½ã€œ~][æœˆç«æ°´æœ¨é‡‘åœŸæ—¥])?(?:[ã€,][æœˆç«æ°´æœ¨é‡‘åœŸæ—¥](?:[ï½ã€œ~][æœˆç«æ°´æœ¨é‡‘åœŸæ—¥])?)*(?:[ã€,](?:ç¥æ—¥|ç¥å‰æ—¥))*)\s*[:ï¼š]/g;
            let blockMatch;
            let bestBlock = null;

            while ((blockMatch = blockPattern.exec(text)) !== null) {
                const daySpec = blockMatch[1];
                if (isDayInSpec(daySpec, today, dayOrder)) {
                    // ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã®é–‹å§‹ä½ç½®ã‹ã‚‰æ¬¡ã®ãƒ–ãƒ­ãƒƒã‚¯ã¾ã§ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
                    const startPos = blockMatch.index + blockMatch[0].length;
                    // æ¬¡ã®ãƒ–ãƒ­ãƒƒã‚¯ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆæœ«å°¾ã¾ã§
                    blockPattern.lastIndex = startPos; // ä¸€æ™‚çš„ã«é€²ã‚ã‚‹
                    const nextMatch = blockPattern.exec(text);
                    const endPos = nextMatch ? nextMatch.index : text.length;
                    blockPattern.lastIndex = startPos; // å…ƒã«æˆ»ã™
                    bestBlock = text.substring(startPos, endPos);
                }
            }
            return bestBlock;
        }

        // æ›œæ—¥æŒ‡å®šã«ä»Šæ—¥ãŒå«ã¾ã‚Œã‚‹ã‹åˆ¤å®š
        function isDayInSpec(spec, today, dayOrder) {
            const todayIdx = dayOrder.indexOf(today);
            // ç¯„å›²æŒ‡å®š: "æœˆï½é‡‘"
            const rangePattern = /([æœˆç«æ°´æœ¨é‡‘åœŸæ—¥])[ï½ã€œ~]([æœˆç«æ°´æœ¨é‡‘åœŸæ—¥])/g;
            let rm;
            while ((rm = rangePattern.exec(spec)) !== null) {
                const startIdx = dayOrder.indexOf(rm[1]);
                const endIdx = dayOrder.indexOf(rm[2]);
                if (startIdx <= endIdx) {
                    if (todayIdx >= startIdx && todayIdx <= endIdx) return true;
                } else {
                    // åœŸï½æœˆ ã®ã‚ˆã†ãªè·¨ã
                    if (todayIdx >= startIdx || todayIdx <= endIdx) return true;
                }
            }
            // å€‹åˆ¥æŒ‡å®š: "åœŸ" "æ—¥"
            if (spec.includes(today)) return true;
            return false;
        }

        // =====================================================================
        //  ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UIåˆæœŸåŒ–
        // =====================================================================
        function initFilterUI() {
            const chipsContainer = document.getElementById('genre-chips');
            const budgetMinSel = document.getElementById('budget-min');
            const budgetMaxSel = document.getElementById('budget-max');
            const filterToggle = document.getElementById('filter-toggle');
            const filterBody = document.getElementById('filter-body');
            const btnResearch = document.getElementById('btn-research');

            // ã‚¸ãƒ£ãƒ³ãƒ«ãƒãƒƒãƒ—ç”Ÿæˆ
            GENRES.forEach(g => {
                const chip = document.createElement('span');
                chip.className = 'genre-chip';
                chip.dataset.code = g.code;
                chip.textContent = `${g.emoji} ${g.name}`;
                chip.addEventListener('click', () => {
                    if (excludedGenres.has(g.code)) {
                        excludedGenres.delete(g.code);
                        chip.classList.remove('excluded');
                    } else {
                        excludedGenres.add(g.code);
                        chip.classList.add('excluded');
                    }
                });
                chipsContainer.appendChild(chip);
            });

            // äºˆç®—ã‚»ãƒ¬ã‚¯ãƒˆç”Ÿæˆ
            BUDGETS.forEach(b => {
                const opt1 = new Option(b.name, b.code);
                const opt2 = new Option(b.name, b.code);
                budgetMinSel.appendChild(opt1);
                budgetMaxSel.appendChild(opt2);
            });

            // ãƒˆã‚°ãƒ«é–‹é–‰
            filterToggle.addEventListener('click', () => {
                const isOpen = filterBody.style.display !== 'none';
                filterBody.style.display = isOpen ? 'none' : 'block';
                filterToggle.classList.toggle('open', !isOpen);
            });

            // å†æ¤œç´¢ãƒœã‚¿ãƒ³
            btnResearch.addEventListener('click', async () => {
                if (!userLocation && !IS_DEBUG) {
                    statusBar.textContent = 'âš ï¸ ä½ç½®æƒ…å ±ãŒæœªå–å¾—ã§ã™ã€‚';
                    return;
                }

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«åˆ‡ã‚Šæ›¿ãˆ
                btnResearch.disabled = true;
                btnResearch.textContent = 'â³ æ¤œç´¢ä¸­â€¦';
                btnResearch.style.opacity = '0.5';
                btnResearch.style.pointerEvents = 'none';

                try {
                    if (IS_DEBUG) {
                        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¸ãƒ£ãƒ³ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                        choices = choices.filter(c => c.type !== 'shop');
                        const filtered = MOCK_SHOPS.filter(s => !excludedGenres.has(s.genreCode));
                        loadShops(filtered.length > 0 ? filtered : MOCK_SHOPS);
                        renderChoicesUI();
                        drawRoulette();
                        statusBar.textContent = 'ğŸ› ï¸ ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ï¼‰';
                    } else {
                        await searchShops();
                    }
                } finally {
                    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤
                    btnResearch.disabled = false;
                    btnResearch.textContent = 'ğŸ”„ ã“ã®æ¡ä»¶ã§å†æ¤œç´¢';
                    btnResearch.style.opacity = '1';
                    btnResearch.style.pointerEvents = 'auto';
                }
            });
        }

        // =====================================================================
        //  ã‚·ãƒ§ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ©ãƒ³ãƒ€ãƒ 5åº—èˆ—ï¼‰
        // =====================================================================
        function loadShops(allShops) {
            const shuffled = [...allShops].sort(() => Math.random() - 0.5);
            const picked = shuffled.slice(0, Math.min(5, shuffled.length));
            picked.forEach(shop => {
                addChoice(shop.name, 'shop', 5, true, shop);
            });
            return picked.length;
        }

        // =====================================================================
        //  é¸æŠè‚¢ç®¡ç†
        // =====================================================================
        function addChoice(name, type, weight, enabled, data) {
            choices.push({ id: idCounter++, name, type, weight, enabled, data: data || {} });
        }

        function removeChoice(id) {
            choices = choices.filter(c => c.id !== id);
            renderChoicesUI();
            drawRoulette();
        }

        function getEnabledChoices() {
            return choices.filter(c => c.enabled);
        }

        // =====================================================================
        //  UI: é¸æŠè‚¢ãƒªã‚¹ãƒˆæç”»
        // =====================================================================
        function renderChoicesUI() {
            choicesList.innerHTML = '';
            // åº—èˆ—ã‚’å…ˆã€ã‚«ã‚¹ã‚¿ãƒ ã‚’å¾Œã«è¡¨ç¤º
            const sorted = [...choices].sort((a, b) => (a.type === 'shop' ? 0 : 1) - (b.type === 'shop' ? 0 : 1));
            sorted.forEach((c, i) => {
                const color = PALETTE[i % PALETTE.length];
                const el = document.createElement('div');
                el.className = 'flex items-center gap-3 p-3 bg-gray-50 rounded-xl transition hover:bg-gray-100';

                const emoji = c.type === 'shop' ? 'ğŸ½ï¸' : (c.data.emoji || 'âœ¨');
                const pct = calcPercent(c);

                el.innerHTML = `
        <label class="flex items-center gap-2 cursor-pointer flex-shrink-0">
          <input type="checkbox" data-id="${c.id}" ${c.enabled ? 'checked' : ''}
                 class="w-5 h-5 rounded accent-primary" />
          <span class="w-3 h-3 rounded-full flex-shrink-0" style="background:${color}"></span>
        </label>
        <div class="flex-1 min-w-0">
          ${c.type === 'shop' && c.data.url
                        ? `<a href="${c.data.url}" target="_blank" rel="noopener" class="text-sm font-semibold text-accent truncate block hover:text-orange-600 transition" style="text-decoration:none">${emoji} ${c.name} <span class="text-xs text-gray-400">â†—</span></a>`
                        : `<p class="text-sm font-semibold text-accent truncate">${emoji} ${c.name}</p>`
                    }
          <div class="flex items-center gap-2 mt-1">
            <input type="range" min="1" max="10" value="${c.weight}" data-id="${c.id}"
                   class="flex-1" style="accent-color:${color}" />
            <span class="text-xs font-bold w-12 text-right" style="color:${color}">${pct}%</span>
          </div>
        </div>
        ${c.type === 'custom' ? `<button data-remove="${c.id}" class="text-gray-300 hover:text-red-400 text-lg transition ml-1">âœ•</button>` : ''}
      `;
                choicesList.appendChild(el);
            });

            // ã‚¤ãƒ™ãƒ³ãƒˆ
            choicesList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', e => {
                    const id = parseInt(e.target.dataset.id);
                    const c = choices.find(x => x.id === id);
                    if (c) c.enabled = e.target.checked;
                    renderChoicesUI();
                    drawRoulette();
                });
            });

            choicesList.querySelectorAll('input[type="range"]').forEach(sl => {
                sl.addEventListener('input', e => {
                    const id = parseInt(e.target.dataset.id);
                    const c = choices.find(x => x.id === id);
                    if (c) c.weight = parseInt(e.target.value);
                    // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã®ã¿è»½é‡æ›´æ–°ï¼ˆDOMå…¨å†æ§‹ç¯‰ã—ãªã„ï¼‰
                    choicesList.querySelectorAll('input[type="range"]').forEach(s => {
                        const cid = parseInt(s.dataset.id);
                        const ch = choices.find(x => x.id === cid);
                        if (ch) {
                            const pctEl = s.parentElement.querySelector('span');
                            if (pctEl) pctEl.textContent = calcPercent(ch) + '%';
                        }
                    });
                    requestAnimationFrame(() => drawRoulette());
                });
            });

            choicesList.querySelectorAll('[data-remove]').forEach(btn => {
                btn.addEventListener('click', e => {
                    removeChoice(parseInt(e.target.dataset.remove));
                });
            });
        }

        function calcPercent(choice) {
            const enabled = getEnabledChoices();
            if (!choice.enabled || enabled.length === 0) return 0;
            const total = enabled.reduce((s, c) => s + c.weight, 0);
            return Math.round((choice.weight / total) * 100);
        }

        // =====================================================================
        //  ã‚«ã‚¹ã‚¿ãƒ é¸æŠè‚¢è¿½åŠ 
        // =====================================================================
        btnAdd.addEventListener('click', () => {
            const val = customInput.value.trim();
            if (!val) return;
            addChoice(val, 'custom', 5, true, { emoji: 'ğŸŒŸ' });
            customInput.value = '';
            renderChoicesUI();
            drawRoulette();
        });
        customInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') { e.preventDefault(); btnAdd.click(); }
        });

        // =====================================================================
        //  Canvas ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæç”»
        // =====================================================================
        let currentRotation = 0;

        function drawRoulette(rotation = currentRotation) {
            const enabled = getEnabledChoices();
            ctx.clearRect(0, 0, SIZE, SIZE);
            const cx = SIZE / 2, cy = SIZE / 2, r = SIZE / 2 - 4;

            if (enabled.length === 0) {
                ctx.fillStyle = '#E0E0E0';
                ctx.beginPath();
                ctx.arc(cx, cy, r, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#999';
                ctx.font = '600 14px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('é¸æŠè‚¢ã‚’è¿½åŠ ã—ã¦ãã ã•ã„', cx, cy);
                return;
            }

            const total = enabled.reduce((s, c) => s + c.weight, 0);
            let angle = rotation;

            enabled.forEach((c, i) => {
                const sliceAngle = (c.weight / total) * Math.PI * 2;
                const color = PALETTE[choices.indexOf(c) % PALETTE.length];

                // ã‚»ã‚¯ã‚¿ãƒ¼
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.arc(cx, cy, r, angle, angle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                // ãƒ©ãƒ™ãƒ«
                const mid = angle + sliceAngle / 2;
                const labelR = r * 0.62;
                const lx = cx + Math.cos(mid) * labelR;
                const ly = cy + Math.sin(mid) * labelR;

                ctx.save();
                ctx.translate(lx, ly);
                ctx.rotate(mid + Math.PI / 2);

                const fontSize = sliceAngle > 0.4 ? 12 : sliceAngle > 0.25 ? 10 : 8;
                ctx.font = `700 ${fontSize}px Inter, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#fff';
                ctx.shadowColor = 'rgba(0,0,0,.4)';
                ctx.shadowBlur = 3;

                // åå‰ã‚’çŸ­ç¸®
                let label = c.name.length > 8 ? c.name.slice(0, 7) + 'â€¦' : c.name;
                ctx.fillText(label, 0, 0);

                ctx.restore();
                angle += sliceAngle;
            });

            // ä¸­å¿ƒå††
            ctx.beginPath();
            ctx.arc(cx, cy, 18, 0, Math.PI * 2);
            ctx.fillStyle = '#FFAB40';
            ctx.fill();
            ctx.beginPath();
            ctx.arc(cx, cy, 8, 0, Math.PI * 2);
            ctx.fillStyle = '#fff';
            ctx.fill();
        }

        // =====================================================================
        //  ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        // =====================================================================
        btnStart.addEventListener('click', () => {
            if (spinning) return;
            const enabled = getEnabledChoices();
            if (enabled.length === 0) return;

            spinning = true;
            btnStart.disabled = true;

            // é‡ã¿ä»˜ãæŠ½é¸ â†’ å½“é¸ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ±ºå®š
            const total = enabled.reduce((s, c) => s + c.weight, 0);
            let rand = Math.random() * total;
            let winnerIdx = 0;
            for (let i = 0; i < enabled.length; i++) {
                rand -= enabled[i].weight;
                if (rand <= 0) { winnerIdx = i; break; }
            }

            // å½“é¸ã‚»ã‚¯ã‚¿ãƒ¼ã®ä¸­å¤®è§’åº¦ã‚’è¨ˆç®—
            let cumAngle = 0;
            for (let i = 0; i < winnerIdx; i++) {
                cumAngle += (enabled[i].weight / total) * Math.PI * 2;
            }
            const winSlice = (enabled[winnerIdx].weight / total) * Math.PI * 2;
            const winMid = cumAngle + winSlice / 2;

            // ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã¯ä¸Šéƒ¨ï¼ˆ-Ï€/2ï¼‰ãªã®ã§ã€å½“é¸ä¸­å¤®ãŒãã“ã«æ¥ã‚‹ã‚ˆã†ã«æœ€çµ‚è§’åº¦ã‚’è¨ˆç®—
            // æœ€çµ‚çš„ãªå›è»¢é‡ = è¤‡æ•°å›è»¢ + èª¿æ•´è§’åº¦
            const extraSpins = 5 + Math.floor(Math.random() * 3); // 5ã€œ7å›è»¢
            const targetAngle = extraSpins * Math.PI * 2 + (Math.PI * 2 - winMid - Math.PI / 2);

            const startTime = performance.now();
            const duration = 4000 + Math.random() * 1000; // 4ã€œ5ç§’
            const startRotation = currentRotation;

            function animate(now) {
                const elapsed = now - startTime;
                const t = Math.min(elapsed / duration, 1);
                // ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°: easeOutCubic â†’ æœ€å¾Œã«ã‚†ã£ãã‚Š
                const ease = 1 - Math.pow(1 - t, 3);
                currentRotation = startRotation + targetAngle * ease;

                drawRoulette(currentRotation);

                if (t < 1) {
                    requestAnimationFrame(animate);
                } else {
                    spinning = false;
                    btnStart.disabled = false;
                    showResult(enabled[winnerIdx]);
                }
            }

            requestAnimationFrame(animate);
        });

        // =====================================================================
        //  çµæœè¡¨ç¤º
        // =====================================================================
        function showResult(winner) {
            const titleEl = document.getElementById('result-title');
            const subEl = document.getElementById('result-sub');
            const imgEl = document.getElementById('result-img');
            const actionEl = document.getElementById('result-action');
            const emojiEl = document.getElementById('result-emoji');

            if (winner.type === 'shop') {
                emojiEl.textContent = 'ğŸ‰';
                titleEl.textContent = winner.name;
                subEl.textContent = winner.data.catch || winner.data.genre || 'é‹å‘½ã®ãŠåº—ãŒæ±ºã¾ã‚Šã¾ã—ãŸï¼';

                if (winner.data.photo) {
                    imgEl.src = winner.data.photo;
                    imgEl.classList.remove('hidden');
                } else {
                    imgEl.classList.add('hidden');
                }

                actionEl.textContent = 'ğŸ”¥ ä»Šã™ãäºˆç´„ã™ã‚‹ï¼ˆãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ï¼‰';
                actionEl.href = winner.data.url || 'https://www.hotpepper.jp/';
                actionEl.classList.remove('hidden');
            } else {
                const emojis = { 'ã‚³ãƒ³ãƒ“ãƒ‹': 'ğŸª', 'è‡ªç‚Š': 'ğŸ³', 'æ–­é£Ÿï¼ˆé£Ÿã¹ãªã„ï¼‰': 'ğŸ§˜' };
                emojiEl.textContent = emojis[winner.name] || winner.data.emoji || 'âœ¨';
                titleEl.textContent = winner.name;

                const messages = {
                    'ã‚³ãƒ³ãƒ“ãƒ‹': 'è¿‘ãã®ã‚³ãƒ³ãƒ“ãƒ‹ã¸GOï¼æ„å¤–ãªæ–°å•†å“ã«å‡ºä¼šãˆã‚‹ã‹ã‚‚ ğŸ›’',
                    'è‡ªç‚Š': 'ä»Šæ—¥ã¯ã‚·ã‚§ãƒ•ãƒ¢ãƒ¼ãƒ‰ç™ºå‹•ï¼å†·è”µåº«ã®ä¸­èº«ã§å¥‡è·¡ã‚’èµ·ã“ãã† ğŸ‘¨â€ğŸ³',
                    'æ–­é£Ÿï¼ˆé£Ÿã¹ãªã„ï¼‰': 'ä¿®è¡Œåƒ§ãƒ¢ãƒ¼ãƒ‰çªå…¥ã€‚ç²¾ç¥ã‚’é›ãˆã‚‹ãƒãƒ£ãƒ³ã‚¹ã§ã™ ğŸ™',
                };
                subEl.textContent = messages[winner.name] || `ã€Œ${winner.name}ã€ã«æ±ºå®šï¼é‹å‘½ã‚’å—ã‘å…¥ã‚Œã‚ˆã† ğŸ²`;

                imgEl.classList.add('hidden');

                if (winner.name === 'è‡ªç‚Š') {
                    actionEl.textContent = 'ğŸ“– ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢ï¼ˆGoogleï¼‰';
                    actionEl.href = 'https://www.google.com/search?q=ç°¡å˜+ãƒ¬ã‚·ãƒ”+ä»Šæ—¥ã®æ™©ã”ã¯ã‚“';
                    actionEl.classList.remove('hidden');
                } else if (winner.name === 'ã‚³ãƒ³ãƒ“ãƒ‹') {
                    actionEl.textContent = 'ğŸ—ºï¸ è¿‘ãã®ã‚³ãƒ³ãƒ“ãƒ‹ã‚’æ¢ã™';
                    actionEl.href = 'https://www.google.com/maps/search/ã‚³ãƒ³ãƒ“ãƒ‹/';
                    actionEl.classList.remove('hidden');
                } else if (winner.name === 'æ–­é£Ÿï¼ˆé£Ÿã¹ãªã„ï¼‰') {
                    actionEl.textContent = 'ğŸ§˜ ç‘æƒ³BGMã‚’è´ã';
                    actionEl.href = 'https://www.youtube.com/results?search_query=ç‘æƒ³+BGM';
                    actionEl.classList.remove('hidden');
                } else {
                    actionEl.textContent = `ğŸ” "${winner.name}" ã‚’æ¤œç´¢`;
                    actionEl.href = `https://www.google.com/search?q=${encodeURIComponent(winner.name)}+è¿‘ã`;
                    actionEl.classList.remove('hidden');
                }
            }

            modal.classList.add('active');
        }

        // ãƒªãƒˆãƒ©ã‚¤
        document.getElementById('btn-retry').addEventListener('click', () => {
            modal.classList.remove('active');
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹
        modal.addEventListener('click', e => {
            if (e.target === modal) modal.classList.remove('active');
        });

        // =====================================================================
        //  èµ·å‹•
        // =====================================================================
        init();
    </script>
</body>

</html>