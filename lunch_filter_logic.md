# ランチ営業フィルタリングの仕組み

## 1. 概要
「ランチモード」を選択した際に、ランチ営業を行っていない店舗を除外する仕組みには、**APIレベル**と**クライアントサイドレベル**の2段階のフィルタリングが存在します。

## 2. APIレベルでのフィルタ（一次選別）
ランチモード選択時、HotPepper APIへのリクエストには以下のパラメータが付与されます。

- **パラメータ**: `lunch=1`
- **効果**: 「ランチ営業あり」として登録されている店舗のみをAPIが返します。
- **注意点**: APIのデータ更新ラグや登録情報の不備により、実際にはランチ営業をしていない（または情報がない）店舗が含まれる場合があります。

## 3. クライアントサイドでのフィルタ（二次選別・厳格化）
APIから取得した店舗データ内に含まれる `lunch` フィールド（平均予算テキスト）を解析し、より厳密な判定を行います。

### 判定ロジック
アプリ内の `searchShops` 関数にて、以下の処理が行われます。

1. **予算フィルタが有効な場合**（上限・下限の指定あり）
    - `shop.lunch` フィールドのテキストを確認します。
    - **「なし」「空白」「解析不能」の場合**:
        - デフォルトで `false`（除外）と判定されます。
        - これにより、「ランチ予算：なし」と明記されている店舗（例：ディナー専門店）は、仮にAPIが返してきたとしても検索結果から排除されます。
    - **価格情報がある場合**:
        - 正規表現 `(\d[\d,]*)` で価格を抽出し、指定範囲内であれば通過します。

2. **予算フィルタが無効な場合**（指定なし）
    - 基本的にAPIの `lunch=1` の結果を信用して全件表示します。
    - ただし、UI上の表示（カード内の「ランチ」項目）には「なし」と表示される場合があります。

## 4. 「ランチなし」が除外される具体例

- **ケース**: 焼肉店（ディナーメイン）
- **データ**: `lunch` フィールド = `"なし"`
- **API**: `lunch=1` で検索してもヒットしてしまう場合がある（登録ミス等）。
- **アプリ挙動**:
    - ユーザーが「上限1000円」などで検索を実行。
    - クライアントフィルタが `shop.lunch` をチェック。
    - 値が `"なし"` なので正規表現マッチに失敗。
    - `return false` となり、リストから除外される。

## 5. まとめ
この2段階の構えにより、「ランチ検索なのにランチをやっていない店が出る」「予算を指定したのに価格不明な店が出る」といったノイズを効果的に除去しています。
