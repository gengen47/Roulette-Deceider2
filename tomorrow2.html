<!DOCTYPE html>
<html lang="ja">

<head>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y5P8DCKR9V"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-Y5P8DCKR9V');
    </script>

    <!-- Leaflet CSS/JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ã‚°ãƒ«ã‚­ãƒ¡ï¼ - é‹å‘½ã®ã‚´ãƒãƒ³ã€å›ã—ã¦æ±ºã‚ã‚ˆã†ï¼ | ãƒ©ãƒ³ãƒãƒ»ãƒ‡ã‚£ãƒŠãƒ¼ã®é£²é£Ÿåº—é¸ã³ã‚¢ãƒ—ãƒª</title>
    <meta name="description"
        content="ä»Šæ—¥ã®ã‚´ãƒãƒ³ã«è¿·ã£ãŸã‚‰ã€Œã‚°ãƒ«ã‚­ãƒ¡ï¼ã€è¿‘ãã®é£²é£Ÿåº—ã‹ã‚‰ãƒ©ãƒ³ãƒã‚„ãƒ‡ã‚£ãƒŠãƒ¼ã®å€™è£œã‚’è‡ªå‹•ã§ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã€ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã§é‹å‘½ã®ä¸€é£Ÿã‚’å³æ±ºï¼å„ªæŸ”ä¸æ–­ãªã‚ãªãŸã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ç„¡æ–™Webã‚¢ãƒ—ãƒªã§ã™ã€‚" />
    <meta name="keywords" content="ãƒ©ãƒ³ãƒ,ãƒ‡ã‚£ãƒŠãƒ¼,é£²é£Ÿåº—,ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ,æ±ºã¾ã‚‰ãªã„,ã‚°ãƒ«ã‚­ãƒ¡,ãã‚‹ãã‚,ã‚°ãƒ«ãƒ¡,é£Ÿäº‹ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ" />
    <link rel="canonical" href="https://gurukime.com/" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://gurukime.com/" />
    <meta property="og:title" content="ã‚°ãƒ«ã‚­ãƒ¡ï¼ - é‹å‘½ã®ã‚´ãƒãƒ³ã€å›ã—ã¦æ±ºã‚ã‚ˆã†ï¼" />
    <meta property="og:description" content="ä½•é£Ÿã¹ã‚‹ï¼Ÿã§æ‚©ã‚“ã ã‚‰ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã§å³æ±ºï¼å‘¨è¾ºã®é£²é£Ÿåº—ã‹ã‚‰é‹å‘½ã®ä¸€é£Ÿã‚’æ±ºã‚ã‚ˆã†ã€‚" />
    <meta property="og:image" content="https://gurukime.com/icons/icon-512.png" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://gurukime.com/" />
    <meta property="twitter:title" content="ã‚°ãƒ«ã‚­ãƒ¡ï¼ - é‹å‘½ã®ã‚´ãƒãƒ³ã€å›ã—ã¦æ±ºã‚ã‚ˆã†ï¼" />
    <meta property="twitter:description" content="ä½•é£Ÿã¹ã‚‹ï¼Ÿã§æ‚©ã‚“ã ã‚‰ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã§å³æ±ºï¼å‘¨è¾ºã®é£²é£Ÿåº—ã‹ã‚‰é‹å‘½ã®ä¸€é£Ÿã‚’æ±ºã‚ã‚ˆã†ã€‚" />
    <meta property="twitter:image" content="https://gurukime.com/icons/icon-512.png" />

    <!-- LD-JSON -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "ã‚°ãƒ«ã‚­ãƒ¡ï¼",
      "alternateName": "ãã‚‹ãã‚",
      "operatingSystem": "Web",
      "applicationCategory": "LifestyleApplication",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "JPY"
      },
      "description": "å‘¨è¾ºã®é£²é£Ÿåº—ã‚’æ¤œç´¢ã—ã€ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã§ãƒ©ãƒ³ãƒã‚„ãƒ‡ã‚£ãƒŠãƒ¼ã®ãŠåº—ã‚’æ±ºã‚ã‚‹Webã‚¢ãƒ—ãƒªã€‚",
      "image": "https://gurukime.com/icons/icon-512.png",
      "url": "https://gurukime.com/",
      "author": {
        "@type": "Person",
        "name": "Ogura Genichirou"
      }
    }
    </script>

    <!-- ===== PWA ===== -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#FFAB40" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="ã‚°ãƒ«ã‚­ãƒ¡ï¼" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />

    <style>
        /* Map Specific Styles */
        #map {
            width: 100%;
            height: 360px;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 0;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 0.75rem;
            font-family: 'Inter', sans-serif;
        }

        .leaflet-popup-content h3 {
            font-weight: 700;
            color: #212121;
            margin-bottom: 2px;
        }
    </style>

    <!-- ===== LinkSwitch ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼ˆãƒãƒªãƒ¥ãƒ¼ã‚³ãƒãƒ¼ã‚¹åç›ŠåŒ–ç”¨ï¼‰ ===== -->
    <!-- <script type="text/javascript" src="//tag.valuecommerce.com/linkswitch.js"></script> -->

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FFAB40',
                        accent: '#212121',
                        surface: '#FAFAFA',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                },
            },
        };
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap"
        rel="stylesheet" />

    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #FAFAFA;
            -webkit-tap-highlight-color: transparent;
        }

        /* ---------- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ ---------- */
        #roulette-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #roulette-canvas {
            border-radius: 50%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, .15);
        }

        /* ä¸‰è§’ã®ãƒã‚¤ãƒ³ã‚¿ãƒ¼ */
        .pointer {
            position: absolute;
            top: -14px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 14px solid transparent;
            border-right: 14px solid transparent;
            border-top: 28px solid #212121;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, .3));
            z-index: 10;
        }

        /* ---------- START ãƒœã‚¿ãƒ³ ---------- */
        .btn-start {
            background: linear-gradient(135deg, #FFAB40 0%, #FF8F00 100%);
            color: #fff;
            font-weight: 800;
            font-size: 1.25rem;
            letter-spacing: .05em;
            border: none;
            border-radius: 9999px;
            padding: .9rem 3rem;
            box-shadow: 0 6px 20px rgba(255, 171, 64, .45);
            cursor: pointer;
            transition: transform .15s, box-shadow .15s;
            -webkit-user-select: none;
            user-select: none;
        }

        .btn-start:active {
            transform: scale(.95);
            box-shadow: 0 3px 10px rgba(255, 171, 64, .3);
        }

        .btn-start:disabled {
            opacity: .5;
            cursor: not-allowed;
        }

        /* ---------- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ ---------- */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #E0E0E0;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            background: #FFAB40;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .2);
            cursor: pointer;
        }

        /* ---------- çµæœãƒ¢ãƒ¼ãƒ€ãƒ« ---------- */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .55);
            backdrop-filter: blur(6px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity .3s;
        }

        .modal-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-card {
            background: #fff;
            border-radius: 1.5rem;
            padding: 2rem 1.5rem;
            max-width: 360px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, .25);
            transform: translateY(30px);
            transition: transform .3s;
        }

        .modal-backdrop.active .modal-card {
            transform: translateY(0);
        }

        /* ---------- é›‘å¤š ---------- */
        .chip {
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            background: #FFF3E0;
            color: #E65100;
            padding: .3rem .75rem;
            border-radius: 9999px;
            font-size: .75rem;
            font-weight: 600;
        }

        .fade-in {
            animation: fadeIn .4s ease both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* è¿½åŠ å…¥åŠ› */
        .add-input {
            border: 2px dashed #FFAB40;
            border-radius: .75rem;
            padding: .5rem .75rem;
            outline: none;
            font-size: .875rem;
            width: 100%;
            transition: border-color .2s;
        }

        .add-input:focus {
            border-color: #FF8F00;
        }

        /* ---------- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒãƒ« ---------- */
        .filter-panel {
            border: 1px solid #F0F0F0;
            border-radius: 1rem;
            overflow: hidden;
            transition: max-height .3s ease;
        }

        .filter-toggle {
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
        }

        .filter-toggle .arrow {
            transition: transform .2s;
        }

        .filter-toggle.open .arrow {
            transform: rotate(180deg);
        }

        .genre-chip {
            display: inline-flex;
            align-items: center;
            gap: .25rem;
            padding: .35rem .7rem;
            border-radius: 9999px;
            font-size: .75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .15s;
            border: 2px solid #E0E0E0;
            background: #fff;
            color: #616161;
        }

        .genre-chip.excluded {
            border-color: #EF5350;
            background: #FFEBEE;
            color: #C62828;
            text-decoration: line-through;
        }

        .budget-select {
            appearance: none;
            -webkit-appearance: none;
            background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M6 8L1 3h10z' fill='%23666'/%3E%3C/svg%3E") no-repeat right .75rem center;
            border: 2px solid #E0E0E0;
            border-radius: .75rem;
            padding: .5rem 2rem .5rem .75rem;
            font-size: .875rem;
            outline: none;
            transition: border-color .2s;
            width: 100%;
        }

        .budget-select:focus {
            border-color: #FFAB40;
        }

        .btn-search {
            background: linear-gradient(135deg, #42A5F5 0%, #1E88E5 100%);
            color: #fff;
            font-weight: 700;
            font-size: .875rem;
            border: none;
            border-radius: 9999px;
            padding: .6rem 1.5rem;
            box-shadow: 0 4px 12px rgba(66, 165, 245, .35);
            cursor: pointer;
            transition: transform .15s, box-shadow .15s;
        }

        .btn-search:active {
            transform: scale(.95);
        }

        .btn-search:disabled {
            opacity: .5;
            cursor: not-allowed;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== -->
    <header class="px-4 pt-1 pb-2 flex flex-col items-center justify-center sticky top-0 z-50 relative"
        style="background:#FAFAFA;">

        <!-- ãƒ˜ãƒ«ãƒ—ã‚¢ã‚¤ã‚³ãƒ³ -->
        <a href="/guide.html"
            class="absolute right-4 top-1/2 transform -translate-y-1/2 p-2 text-gray-400 hover:text-accent transition"
            aria-label="ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </a>

        <!-- æˆ»ã‚‹ã‚¢ã‚¤ã‚³ãƒ³ -->
        <a href="/index.html"
            class="absolute left-4 top-1/2 transform -translate-y-1/2 p-2 text-gray-400 hover:text-accent transition"
            aria-label="ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        </a>

        <img src="logo.svg" alt="ã‚°ãƒ«ã‚­ãƒ¡ï¼(ãã‚‹ãã‚)" style="height:44px; object-fit:contain;" />
        <p class="text-xs text-gray-500 mt-1">é‹å‘½ã®ã‚´ãƒãƒ³ã€å›ã—ã¦æ±ºã‚ã‚ˆã†ï¼</p>
    </header>

    <!-- ===== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ===== -->
    <main class="flex-1 flex flex-col items-center px-4 pb-8 w-full max-w-md mx-auto">

        <h1 class="text-xl font-bold text-accent mb-4 mt-2">ğŸ—ºï¸ åœ°å›³ã‹ã‚‰ãŠåº—ã‚’æ¢ã™</h1>

        <!-- åœ°å›³ -->
        <div id="map" class="mb-4 relative">
            <!-- Crosshair -->
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none z-[1000]"
                style="filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#FFAB40" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </div>
        </div>

        <div id="status-bar" class="w-full mb-3 text-center text-sm text-gray-500 fade-in">
            ğŸ“ åœ°å›³ã§å ´æ‰€ã‚’æ±ºã‚ã¦ãã ã•ã„
        </div>

        <button id="btn-search-area"
            class="w-full bg-primary text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition transform active:scale-95 mb-6 flex items-center justify-center gap-2">
            <span>ğŸ” ã“ã®ã‚¨ãƒªã‚¢ã§æ¤œç´¢</span>
        </button>

        <!-- ===== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒãƒ« ===== -->
        <section class="w-full max-w-md mt-2 mb-3 filter-panel bg-white shadow-sm fade-in">
            <div id="filter-toggle" class="filter-toggle flex items-center justify-between px-4 py-3">
                <h2 class="text-sm font-bold text-accent flex items-center gap-2">ğŸ” åº—èˆ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h2>
                <span class="arrow text-gray-400 text-xs">â–¼</span>
            </div>
            <div id="filter-body" class="px-4 pb-4" style="display:none;">
                <!-- ã‚¸ãƒ£ãƒ³ãƒ«é™¤å¤– -->
                <p class="text-xs text-gray-400 font-semibold mb-2">é™¤å¤–ã™ã‚‹ã‚¸ãƒ£ãƒ³ãƒ«ï¼ˆã‚¿ãƒƒãƒ—ã§é™¤å¤–ï¼‰</p>
                <div id="genre-chips" class="flex flex-wrap gap-2 mb-4"></div>

                <!-- è·é›¢ -->
                <p class="text-xs text-gray-400 font-semibold mb-2">ğŸ“ ç¾åœ¨åœ°ã‹ã‚‰ã®è·é›¢</p>
                <select id="distance-range" class="budget-select mb-4">
                    <option value="1">300mä»¥å†…</option>
                    <option value="2">500mä»¥å†…</option>
                    <option value="3" selected>1kmä»¥å†…</option>
                    <option value="4">2kmä»¥å†…</option>
                    <option value="5">3kmä»¥å†…</option>
                </select>

                <!-- ãƒ©ãƒ³ãƒ/ãƒ‡ã‚£ãƒŠãƒ¼åˆ‡ã‚Šæ›¿ãˆ -->
                <div class="flex bg-gray-100 p-1 rounded-lg mb-4">
                    <label class="flex-1 text-center cursor-pointer">
                        <input type="radio" name="time-mode" value="lunch" class="hidden peer">
                        <span
                            class="block py-1.5 text-sm font-bold text-gray-500 rounded-md peer-checked:bg-white peer-checked:text-accent peer-checked:shadow transition-all">ğŸŒ
                            ãƒ©ãƒ³ãƒ</span>
                    </label>
                    <label class="flex-1 text-center cursor-pointer">
                        <input type="radio" name="time-mode" value="dinner" class="hidden peer" checked>
                        <span
                            class="block py-1.5 text-sm font-bold text-gray-500 rounded-md peer-checked:bg-white peer-checked:text-accent peer-checked:shadow transition-all">ğŸŒ™
                            ãƒ‡ã‚£ãƒŠãƒ¼</span>
                    </label>
                </div>

                <!-- äºˆç®—å¸¯ -->
                <p class="text-xs text-gray-400 font-semibold mb-2">ğŸ’° äºˆç®—å¸¯</p>
                <div class="flex gap-2 mb-4">
                    <select id="budget-min" class="budget-select flex-1">
                        <option value="">ä¸‹é™ãªã—</option>
                    </select>
                    <span class="self-center text-gray-400 text-sm font-bold">ã€œ</span>
                    <select id="budget-max" class="budget-select flex-1">
                        <option value="">ä¸Šé™ãªã—</option>
                    </select>
                </div>

                <!-- å–¶æ¥­ä¸­ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="flex items-center gap-2 mb-4">
                    <label class="flex items-center gap-2 cursor-pointer text-sm font-semibold text-accent">
                        <input type="checkbox" id="filter-open-now" class="w-5 h-5 rounded accent-primary" />
                        ğŸŸ¢ å–¶æ¥­ä¸­ã®åº—èˆ—ã®ã¿è¡¨ç¤º
                    </label>
                </div>

                <!-- å†æ¤œç´¢ãƒœã‚¿ãƒ³ -->
                <button id="btn-research" class="btn-search w-full">ğŸ”„ ã“ã®æ¡ä»¶ã§å†æ¤œç´¢</button>
            </div>
        </section>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (Deleted) -->

        <!-- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ -->
        <section id="roulette-container" class="my-4">
            <div class="pointer"></div>
            <canvas id="roulette-canvas" width="300" height="300"></canvas>
        </section>

        <!-- START ãƒœã‚¿ãƒ³ -->
        <button id="btn-start" class="btn-start mt-2 mb-6" disabled>START</button>

        <!-- æ˜æ—¥ã®ã‚°ãƒ«ãƒ¡ãƒãƒŠãƒ¼ (Removed) -->

        <!-- ===== è¨­å®šãƒ‘ãƒãƒ« ===== -->
        <section id="settings-panel" class="w-full max-w-md bg-white rounded-2xl shadow-md p-5 space-y-5 fade-in">
            <h2 class="text-base font-bold text-accent flex items-center gap-2">âš™ï¸ é¸æŠè‚¢ & ç¢ºç‡è¨­å®š</h2>

            <!-- é¸æŠè‚¢ãƒªã‚¹ãƒˆï¼ˆå‹•çš„ç”Ÿæˆï¼‰ -->
            <div id="choices-list" class="space-y-3"></div>

            <!-- ã‚«ã‚¹ã‚¿ãƒ é¸æŠè‚¢è¿½åŠ  -->
            <div class="pt-2 border-t border-gray-100">
                <p class="text-xs text-gray-400 mb-2 font-semibold">ï¼‹ ã‚«ã‚¹ã‚¿ãƒ é¸æŠè‚¢ã‚’è¿½åŠ </p>
                <div class="flex gap-2">
                    <input id="custom-input" type="text" class="add-input flex-1" placeholder="ä¾‹ï¼šãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰"
                        maxlength="20" />
                    <button id="btn-add-custom"
                        class="bg-primary text-white font-bold px-4 py-2 rounded-xl text-sm shadow hover:shadow-md transition">è¿½åŠ </button>
                </div>
            </div>
        </section>
        </section>

        <!-- ===== SEOç”¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ ===== -->
        <section class="w-full max-w-md bg-white rounded-2xl shadow-md p-6 mt-8 mb-4 fade-in">
            <h2 class="text-lg font-bold text-accent mb-3 text-center">è¿‘ãã®ã”ã¯ã‚“ã‚’3ç§’ã§æ±ºã‚ã‚‹ï¼<br>é‹å‘½ã®é£Ÿäº‹ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</h2>
            <div class="text-sm text-gray-600 leading-relaxed space-y-3">
                <p>
                    ã€Œä»Šæ—¥ã®ã”ã¯ã‚“ã€ä½•ã«ã—ã‚ˆã†ï¼Ÿã€ã¨è¿·ã£ã¦ã„ã‚‹ã‚ãªãŸã¸ã€‚<br>
                    <strong>ã‚°ãƒ«ã‚­ãƒ¡ï¼</strong>ã¯ã€ç¾åœ¨åœ°ã‹ã‚‰<strong>è¿‘ãã®é£²é£Ÿåº—</strong>ã‚’ç¬æ™‚ã«æ¤œç´¢ã—ã€ãƒ©ãƒ³ãƒã‚„ãƒ‡ã‚£ãƒŠãƒ¼ã®ãŠåº—ã‚’ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã§æ±ºã‚ã‚‹ç„¡æ–™Webã‚¢ãƒ—ãƒªã§ã™ã€‚
                </p>
                <p>
                    Googleãƒãƒƒãƒ—ã§ã€Œè¿‘ãã®ç¾å‘³ã—ã„ãŠåº—ã€ã‚’æ¤œç´¢ã—ã¦ã‚‚ã€å€™è£œãŒå¤šã™ãã¦é¸ã¹ãªã„ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ<br>
                    ã‚°ãƒ«ã‚­ãƒ¡ï¼ãªã‚‰ã€å‘¨è¾ºã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒ»ã‚«ãƒ•ã‚§ãƒ»å±…é…’å±‹ã‹ã‚‰è‡ªå‹•ã§å€™è£œã‚’ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€‚å„ªæŸ”ä¸æ–­ãªã‚ãªãŸã®ä»£ã‚ã‚Šã«ã€é‹å‘½ã®ä¸€é£Ÿã‚’ã‚ºãƒãƒƒã¨æ±ºå®šã—ã¾ã™ã€‚
                </p>
                <div class="bg-primary/10 p-3 rounded-lg border border-primary/20">
                    <h3 class="font-bold text-accent mb-1 text-xs">ã“ã‚“ãªæ™‚ã«ãŠã™ã™ã‚</h3>
                    <ul class="list-disc list-inside text-xs space-y-1">
                        <li>è·å ´ã®è¿‘ãã§ãƒ©ãƒ³ãƒã‚’é–‹æ‹“ã—ãŸã„æ™‚</li>
                        <li>å‹é”ã¨ã®ãƒ‡ã‚£ãƒŠãƒ¼ã§åº—ãŒæ±ºã¾ã‚‰ãªã„æ™‚</li>
                        <li>æ—…å…ˆã§ç¾åœ¨åœ°å‘¨è¾ºã®ã‚°ãƒ«ãƒ¡ã‚’æ¢ã—ãŸã„æ™‚</li>
                        <li>ã„ã¤ã‚‚åŒã˜åº—ã°ã‹ã‚Šã§ãƒãƒ³ãƒãƒªæ°—å‘³ãªæ™‚</li>
                    </ul>
                </div>
                <p class="text-xs text-gray-400 mt-2">
                    â€»ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ã‚°ãƒ«ãƒ¡ã®APIã‚’ä½¿ç”¨ã—ã€æœ€æ–°ã®åº—èˆ—æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚
                </p>
            </div>
        </section>
    </main>

    <!-- ===== ãƒ•ãƒƒã‚¿ãƒ¼ ===== -->
    <footer class="py-4 text-center text-xs text-gray-400" style="background:#FAFAFA;">
        <a href="http://webservice.recruit.co.jp/" target="_blank" rel="noopener">
            <img src="https://webservice.recruit.co.jp/banner/hotpepper-s.gif" alt="Powered by ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ Webã‚µãƒ¼ãƒ“ã‚¹"
                style="height:16px; display:inline-block; vertical-align:middle;" />
        </a>
        <p class="mt-1">Powered by <a href="http://webservice.recruit.co.jp/" target="_blank" rel="noopener"
                class="text-gray-400 underline">ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ Webã‚µãƒ¼ãƒ“ã‚¹</a></p>
        <p class="mt-1"><a href="/guide.html" class="text-gray-400 underline">ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</a> ï½œ <a href="/privacy.html"
                class="text-gray-400 underline">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a></p>
    </footer>

    <!-- ===== åˆå›è¨ªå•ãƒãƒŠãƒ¼ ===== -->
    <div id="guide-banner"
        class="fixed bottom-4 left-4 right-4 bg-white p-4 rounded-xl shadow-2xl z-50 transform transition-all duration-500 translate-y-full opacity-0 flex items-center justify-between border border-orange-100 max-w-md mx-auto">
        <div class="flex items-center">
            <span class="text-2xl mr-3">ğŸ“–</span>
            <div>
                <p class="font-bold text-sm text-gray-800">ã¯ã˜ã‚ã¦ã®æ–¹ã¸</p>
                <a href="/guide.html" class="text-xs text-accent underline mt-1 block">3ç§’ã§ã‚ã‹ã‚‹ï¼ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ã‚’è¦‹ã‚‹</a>
            </div>
        </div>
        <button onclick="closeGuideBanner()" class="p-2 text-gray-400 hover:text-gray-600 focus:outline-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>

    <!-- ===== çµæœãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
    <div id="result-modal" class="modal-backdrop">
        <div class="modal-card">
            <div id="result-emoji" class="text-5xl mb-3">ğŸ‰</div>
            <h3 id="result-title" class="text-xl font-extrabold text-accent mb-1"></h3>
            <p id="result-sub" class="text-sm text-gray-500 mb-4"></p>
            <img id="result-img" class="w-full rounded-xl mb-4 hidden" alt="åº—èˆ—ç”»åƒ" />
            <a id="result-action" href="#" target="_blank" rel="noopener"
                class="inline-block bg-primary text-white font-bold px-6 py-3 rounded-full shadow-lg text-sm mb-3 hover:shadow-xl transition">
            </a>
            <br />
            <!-- ãƒªãƒˆãƒ©ã‚¤ï¼ˆå°†æ¥çš„ã«åºƒå‘Šã‚’æŒŸã‚ã‚‹è¨­è¨ˆï¼‰ -->
            <!-- ã“ã“ã«åºƒå‘Šã‚¹ãƒ­ãƒƒãƒˆã‚’æŒ¿å…¥å¯èƒ½ -->
            <button id="btn-retry" class="mt-2 text-gray-400 underline text-sm hover:text-accent transition">ğŸ”„
                ã‚‚ã†ä¸€å›ã¾ã‚ã™</button>
        </div>
    </div>

    <!-- ============================= JavaScript ============================= -->
    <script>
        // =====================================================================
        //  è¨­å®š
        // =====================================================================
        const IS_DEBUG = false; // true: ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ‰ / false: æœ¬ç•ªï¼ˆãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼APIï¼‰

        // â˜…æœ¬ç•ªæ™‚ã¯ã“ã“ã«APIã‚­ãƒ¼ã‚’è¨­å®š
        const HP_API_KEY = 'f008a1b21c675ccc';

        // =====================================================================
        //  ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
        // =====================================================================
        const MOCK_SHOPS = [
            { name: 'ç„¼è‚‰ã‚­ãƒ³ã‚° æ¸‹è°·åº—', catch: 'é£Ÿã¹æ”¾é¡ŒãŒå¤§äººæ°—ï¼', genre: 'ç„¼è‚‰', photo: '', url: 'https://www.hotpepper.jp/' },
            { name: 'ã‚¹ã‚·ãƒ­ãƒ¼ æ–°å®¿æ±å£åº—', catch: 'å›è»¢å¯¿å¸ãªã‚‰ã“ã“', genre: 'å¯¿å¸', photo: '', url: 'https://www.hotpepper.jp/' },
            { name: 'ã‚µã‚¤ã‚¼ãƒªãƒ¤ æ± è¢‹åº—', catch: 'ã‚³ã‚¹ãƒ‘æœ€å¼·ã‚¤ã‚¿ãƒªã‚¢ãƒ³', genre: 'ã‚¤ã‚¿ãƒªã‚¢ãƒ³', photo: '', url: 'https://www.hotpepper.jp/' },
            { name: 'CoCoå£±ç•ªå±‹ ç›®é»’åº—', catch: 'ã‚«ãƒ¬ãƒ¼ã®ç‹é“', genre: 'ã‚«ãƒ¬ãƒ¼', photo: '', url: 'https://www.hotpepper.jp/' },
            { name: 'å¤©ä¸‹ä¸€å“ å…­æœ¬æœ¨åº—', catch: 'ã“ã£ã¦ã‚Šãƒ©ãƒ¼ãƒ¡ãƒ³', genre: 'ãƒ©ãƒ¼ãƒ¡ãƒ³', photo: '', url: 'https://www.hotpepper.jp/' },
            { name: 'å¤§æˆ¸å±‹ å“å·åº—', catch: 'ã¡ã‚ƒã‚“ã¨ã‚´ãƒãƒ³', genre: 'å’Œé£Ÿ', photo: '', url: 'https://www.hotpepper.jp/' },
            { name: 'ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰ æ±äº¬é§…åº—', catch: 'ã‚¹ãƒã‚¤ãƒ«0å††ï¼', genre: 'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰', photo: '', url: 'https://www.hotpepper.jp/' },
            { name: 'é³¥è²´æ— æµæ¯”å¯¿åº—', catch: 'å…¨å“å‡ä¸€ä¾¡æ ¼ï¼', genre: 'å±…é…’å±‹', photo: '', url: 'https://www.hotpepper.jp/' },
        ];

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ã‚¹ã‚¿ãƒ é¸æŠè‚¢
        const DEFAULT_CUSTOM = [
            { name: 'ã‚³ãƒ³ãƒ“ãƒ‹', emoji: 'ğŸª' },
            { name: 'è‡ªç‚Š', emoji: 'ğŸ³' },
            { name: 'æ–­é£Ÿï¼ˆé£Ÿã¹ãªã„ï¼‰', emoji: 'ğŸ§˜' },
        ];

        // ã‚¸ãƒ£ãƒ³ãƒ«ãƒã‚¹ã‚¿
        const GENRES = [
            { code: 'G001', name: 'å±…é…’å±‹', emoji: 'ğŸ¶' },
            { code: 'G002', name: 'ãƒ€ã‚¤ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒ»ãƒãƒ«', emoji: 'ğŸ·' },
            { code: 'G003', name: 'å‰µä½œæ–™ç†', emoji: 'ğŸ¨' },
            { code: 'G004', name: 'å’Œé£Ÿ', emoji: 'ğŸ£' },
            { code: 'G005', name: 'æ´‹é£Ÿ', emoji: 'ğŸ' },
            { code: 'G006', name: 'ã‚¤ã‚¿ãƒªã‚¢ãƒ³ãƒ»ãƒ•ãƒ¬ãƒ³ãƒ', emoji: 'ğŸ‡®ğŸ‡¹' },
            { code: 'G007', name: 'ä¸­è¯', emoji: 'ğŸ¥Ÿ' },
            { code: 'G008', name: 'ç„¼è‚‰ãƒ»ãƒ›ãƒ«ãƒ¢ãƒ³', emoji: 'ğŸ¥©' },
            { code: 'G017', name: 'éŸ“å›½æ–™ç†', emoji: 'ğŸ‡°ğŸ‡·' },
            { code: 'G009', name: 'ã‚¢ã‚¸ã‚¢ãƒ»ã‚¨ã‚¹ãƒ‹ãƒƒã‚¯', emoji: 'ğŸ›' },
            { code: 'G010', name: 'å„å›½æ–™ç†', emoji: 'ğŸŒ' },
            { code: 'G011', name: 'ã‚«ãƒ©ã‚ªã‚±ãƒ»ãƒ‘ãƒ¼ãƒ†ã‚£', emoji: 'ğŸ¤' },
            { code: 'G012', name: 'ãƒãƒ¼ãƒ»ã‚«ã‚¯ãƒ†ãƒ«', emoji: 'ğŸ¸' },
            { code: 'G013', name: 'ãƒ©ãƒ¼ãƒ¡ãƒ³', emoji: 'ğŸœ' },
            { code: 'G016', name: 'ãŠå¥½ã¿ç„¼ããƒ»ã‚‚ã‚“ã˜ã‚ƒ', emoji: 'ğŸ¥' },
            { code: 'G014', name: 'ã‚«ãƒ•ã‚§ãƒ»ã‚¹ã‚¤ãƒ¼ãƒ„', emoji: 'â˜•' },
            { code: 'G015', name: 'ãã®ä»–ã‚°ãƒ«ãƒ¡', emoji: 'ğŸ´' },
        ];

        // äºˆç®—ãƒã‚¹ã‚¿ï¼ˆå®‰ã„é †ï¼‰
        // äºˆç®—ãƒã‚¹ã‚¿ï¼ˆå®‰ã„é †ï¼‰
        // â€»å€¤ã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨ã«æ•°å€¤ã‚’æŒãŸã›ã‚‹
        const BUDGETS = [
            { code: 'B009', name: 'ã€œ500å††', min: 0, max: 500 },
            { code: 'B010', name: '501ã€œ1000å††', min: 501, max: 1000 },
            { code: 'B011', name: '1001ã€œ1500å††', min: 1001, max: 1500 },
            { code: 'B001', name: '1501ã€œ2000å††', min: 1501, max: 2000 },
            { code: 'B002', name: '2001ã€œ3000å††', min: 2001, max: 3000 },
            { code: 'B003', name: '3001ã€œ4000å††', min: 3001, max: 4000 },
            { code: 'B008', name: '4001ã€œ5000å††', min: 4001, max: 5000 },
            { code: 'B004', name: '5001ã€œ7000å††', min: 5001, max: 7000 },
            { code: 'B005', name: '7001ã€œ10000å††', min: 7001, max: 10000 },
            { code: 'B006', name: '10001ã€œ15000å††', min: 10001, max: 15000 },
            { code: 'B012', name: '15001ã€œ20000å††', min: 15001, max: 20000 },
            { code: 'B013', name: '20001ã€œ30000å††', min: 20001, max: 30000 },
            { code: 'B014', name: '30001å††ã€œ', min: 30001, max: 999999 },
        ];

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹
        let excludedGenres = new Set(); // é™¤å¤–ã™ã‚‹ã‚¸ãƒ£ãƒ³ãƒ«ã‚³ãƒ¼ãƒ‰
        let userLocation = null;        // { lat, lng }

        // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
        const PALETTE = [
            '#FFAB40', '#FF7043', '#AB47BC', '#42A5F5', '#66BB6A',
            '#FFEE58', '#EF5350', '#26C6DA', '#8D6E63', '#78909C',
            '#EC407A', '#7E57C2', '#29B6F6', '#9CCC65', '#FFA726',
        ];

        // Map Globals
        let map;
        let shopMarkers = [];

        // =====================================================================
        //  State
        // =====================================================================
        let choices = [];   // { id, name, type:'shop'|'custom', weight, enabled, data? }
        let spinning = false;
        let idCounter = 0;

        // DOM
        const canvas = document.getElementById('roulette-canvas');
        const ctx = canvas.getContext('2d');
        const btnStart = document.getElementById('btn-start');
        const choicesList = document.getElementById('choices-list');
        const statusBar = document.getElementById('status-bar');
        const modal = document.getElementById('result-modal');
        const customInput = document.getElementById('custom-input');
        const btnAdd = document.getElementById('btn-add-custom');

        // HiDPI
        const dpr = window.devicePixelRatio || 1;
        const SIZE = 300;
        canvas.width = SIZE * dpr;
        canvas.height = SIZE * dpr;
        canvas.style.width = SIZE + 'px';
        canvas.style.height = SIZE + 'px';
        ctx.scale(dpr, dpr);

        // =====================================================================
        //  åˆæœŸåŒ–
        // =====================================================================
        async function init() {
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UIã‚’åˆæœŸåŒ–
            initFilterUI();

            // MapåˆæœŸåŒ–
            await initMap();

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ã‚¹ã‚¿ãƒ é¸æŠè‚¢
            DEFAULT_CUSTOM.forEach(c => {
                addChoice(c.name, 'custom', 5, false, { emoji: c.emoji });
            });

            renderChoicesUI();
            drawRoulette();
            btnStart.disabled = false;

            // æ¤œç´¢ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            const btnSearch = document.getElementById('btn-search-area');
            if (btnSearch) btnSearch.addEventListener('click', () => searchShops());
        }

        // åº—èˆ—æ¤œç´¢ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ï¼‰
        async function searchShops() {
            const btn = document.getElementById('btn-search-area');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>â³ æ¤œç´¢ä¸­...</span>';
            btn.disabled = true;
            statusBar.textContent = 'åœ°å›³ã®ä¸­å¿ƒå‘¨è¾ºã®ãŠåº—ã‚’æ¤œç´¢ä¸­â€¦';

            // åœ°å›³ä¸­å¿ƒã‚’å–å¾—
            const center = map.getCenter();

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’åé›†
            const budgetMin = document.getElementById('budget-min').value;
            const budgetMax = document.getElementById('budget-max').value;
            const includedGenres = GENRES
                .filter(g => !excludedGenres.has(g.code))
                .map(g => g.code);

            // ãƒ©ãƒ³ãƒãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
            const isLunchMode = document.querySelector('input[name="time-mode"]:checked').value === 'lunch';
            let strictMaxPrice = 999999;

            if (budgetMax) {
                strictMaxPrice = parseInt(budgetMax);
            }

            const rangeVal = document.getElementById('distance-range').value;
            const openNowChecked = document.getElementById('filter-open-now').checked;

            try {
                // APIå‘¼ã³å‡ºã— (center.lat, center.lng)
                // fetchShops ã¯ index.html ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æµç”¨
                let shops = await fetchShops(center.lat, center.lng, includedGenres, [], rangeVal, openNowChecked, isLunchMode);

                // äºˆç®—ã§ã®å³å¯†ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                if (budgetMax || budgetMin) {
                    let strictMinPrice = 0;
                    if (budgetMin) strictMinPrice = parseInt(budgetMin);

                    if (isLunchMode) {
                        shops = shops.filter(s => {
                            const text = s.lunch;
                            if (!text) return false;
                            const match = text.match(/(\d[\d,]*)/);
                            if (match) {
                                const price = parseInt(match[1].replace(/,/g, ''));
                                return price <= strictMaxPrice && price >= strictMinPrice;
                            }
                            if (text.startsWith('ã‚ã‚Š')) {
                                let budgetText = s.budget;
                                if ((!budgetText || budgetText === '') && s.budgetAverage) {
                                    budgetText = s.budgetAverage;
                                }
                                if (budgetText) {
                                    const budgetMatch = budgetText.match(/(\d[\d,]*)/);
                                    if (budgetMatch) {
                                        let dinnerPrice = parseInt(budgetMatch[1].replace(/,/g, ''));
                                        let estimatedLunchPrice = Math.max(0, dinnerPrice - 1000);
                                        return estimatedLunchPrice <= strictMaxPrice && estimatedLunchPrice >= strictMinPrice;
                                    }
                                }
                            }
                            return false;
                        });
                    } else {
                        shops = shops.filter(s => {
                            let text = s.budget;
                            if ((!text || text === '') && s.budgetAverage) {
                                text = s.budgetAverage;
                            }
                            if (!text) return false;
                            const match = text.match(/(\d[\d,]*)/);
                            if (match) {
                                const price = parseInt(match[1].replace(/,/g, ''));
                                return price <= strictMaxPrice && price >= strictMinPrice;
                            }
                            return false;
                        });
                    }
                }

                // ã‚¸ãƒ£ãƒ³ãƒ«é™¤å¤–ãƒ­ã‚¸ãƒƒã‚¯
                if (excludedGenres.size > 0) {
                    shops = shops.filter(s => !excludedGenres.has(s.genreCode));
                }

                // å–¶æ¥­ä¸­ãƒ­ã‚¸ãƒƒã‚¯
                if (openNowChecked) {
                    shops = shops.filter(s => isOpenNow(s));
                }

                // Map Markers Update
                updateMapMarkers(shops);

                // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ›´æ–°
                choices = choices.filter(c => c.type !== 'shop');

                if (shops.length > 0) {
                    const pickCount = loadShops(shops);
                    renderChoicesUI();
                    drawRoulette();
                    statusBar.textContent = `ğŸ“ å‘¨è¾º ${shops.length} åº—èˆ—ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ${pickCount}åº—èˆ—ã‚’é¸å‡º`;

                    // Show Roulette (scroll to it)
                    document.getElementById('roulette-container').scrollIntoView({ behavior: 'smooth' });
                } else {
                    statusBar.textContent = 'æ¡ä»¶ã«åˆã†ãŠåº—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
                    alert('æ¡ä»¶ã«åˆã†ãŠåº—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å ´æ‰€ã‚„æ¡ä»¶ã‚’å¤‰ãˆã¦ã¿ã¦ãã ã•ã„ã€‚');
                }

            } catch (e) {
                console.error(e);
                statusBar.textContent = 'æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function updateMapMarkers(shops) {
            shopMarkers.forEach(m => map.removeLayer(m));
            shopMarkers = [];

            shops.forEach(s => {
                if (!s.lat || !s.lng) return;

                const marker = L.marker([s.lat, s.lng]).addTo(map);

                const popupContent = `
                    <div class="text-sm font-sans p-1">
                        <h3 class="font-bold text-accent mb-1 text-base">${s.name}</h3>
                        <p class="text-xs text-gray-500 mb-2">${s.genre}</p>
                        <p class="text-xs text-gray-400 mb-2">${s.budget}</p>
                        <a href="${s.url}" target="_blank" rel="noopener" 
                           class="bg-primary text-white text-xs font-bold py-2 px-4 rounded text-center block shadow-sm hover:opacity-90 no-underline">
                           è©³ç´°ã‚’è¦‹ã‚‹ (ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼)
                        </a>
                    </div>
                `;

                marker.bindPopup(popupContent);
                shopMarkers.push(marker);
            });
        }

        // =====================================================================
        //  Geolocation
        // =====================================================================
        async function initMap() {
            let lat = 35.681236; // Default Tokyo Station
            let lng = 139.767125;

            // Try Geolocation for initial center
            if (navigator.geolocation) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject);
                    });
                    lat = position.coords.latitude;
                    lng = position.coords.longitude;
                } catch (e) {
                    console.log('Location access denied, using default.');
                }
            }

            map = L.map('map').setView([lat, lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        // =====================================================================
        //  ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼APIï¼ˆVercel Serverless FunctionçµŒç”±ï¼‰
        // =====================================================================
        async function fetchShops(lat, lng, genreCodes = [], budgetCodes = [], range = '3', openNow = false, lunch = false) {
            let params = `lat=${lat}&lng=${lng}&range=${range}&count=100`;

            // ã‚¸ãƒ£ãƒ³ãƒ«æŒ‡å®š
            if (genreCodes.length > 0 && genreCodes.length < GENRES.length) {
                params += `&genre=${genreCodes.join(',')}`;
            }
            // äºˆç®—æŒ‡å®š
            if (budgetCodes.length > 0) {
                params += `&budget=${budgetCodes.join(',')}`;
            }
            // å–¶æ¥­ä¸­ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å‡¦ç†ç”¨ãƒ•ãƒ©ã‚°ï¼‰
            if (openNow) {
                params += '&open_now=true';
            }
            // ãƒ©ãƒ³ãƒå–¶æ¥­ã‚ã‚Šï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å‡¦ç†ç”¨ãƒ•ãƒ©ã‚°ï¼‰
            if (lunch) {
                params += '&lunch=1';
            }

            try {
                const response = await fetch(`/api/shops?${params}`);
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();

                if (data.results && data.results.shop && data.results.shop.length > 0) {
                    return data.results.shop.map(s => ({
                        name: s.name,
                        catch: s.catch || '',
                        genre: s.genre ? s.genre.name : '',
                        genreCode: s.genre ? s.genre.code : '',
                        photo: s.photo && s.photo.pc ? s.photo.pc.l : '',
                        url: s.urls ? s.urls.pc : '',
                        budget: s.budget ? s.budget.name : '',
                        budgetAverage: s.budget ? s.budget.average : '', // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´è§£æç”¨
                        lunch: s.lunch || '', // ãƒ©ãƒ³ãƒäºˆç®—ãƒ†ã‚­ã‚¹ãƒˆ
                        open: s.open || '',
                        close: s.close || '',
                        lat: s.lat, // Added
                        lng: s.lng  // Added
                    }));
                }
                return [];
            } catch (e) {
                console.error('Fetch shops error:', e);
                throw e;
            }
        }


        // =====================================================================
        // æ—¥æœ¬ã®ç¥æ—¥ï¼ˆ2025-2026ï¼‰
        const HOLIDAYS = [
            '2025-01-01', '2025-01-13', '2025-02-11', '2025-02-23', '2025-02-24', '2025-03-20', '2025-04-29', '2025-05-03', '2025-05-04', '2025-05-05', '2025-05-06', '2025-07-21', '2025-08-11', '2025-09-15', '2025-09-23', '2025-10-13', '2025-11-03', '2025-11-23', '2025-11-24',
            '2026-01-01', '2026-01-12', '2026-02-11', '2026-02-23', '2026-03-20', '2026-04-29', '2026-05-03', '2026-05-04', '2026-05-05', '2026-05-06', '2026-07-20', '2026-08-11', '2026-09-21', '2026-09-23', '2026-10-12', '2026-11-03', '2026-11-23',
        ];

        function isJapaneseHoliday(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return HOLIDAYS.includes(`${y}-${m}-${d}`);
        }

        // =====================================================================
        //  å–¶æ¥­ä¸­åˆ¤å®šï¼ˆç¬¬2å±¤: å®šä¼‘æ—¥ + ç¬¬3å±¤: ãƒ†ã‚­ã‚¹ãƒˆè§£æï¼‰
        // =====================================================================
        function isOpenNow(shop) {
            if (!shop.open) return false; // ãƒ‡ãƒ¼ã‚¿ãªã—ã¯é™¤å¤–ï¼ˆå®‰å…¨å´ï¼‰

            const now = new Date();
            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const todayDay = dayNames[now.getDay()];
            const isHoliday = isJapaneseHoliday(now);
            const nowMin = now.getHours() * 60 + now.getMinutes();

            // ç¥æ—¥ã®å ´åˆã®æ›œæ—¥æ‰±ã„ï¼š
            // ã¾ãšã€Œç¥ã€ã¾ãŸã¯ã€Œç¥æ—¥ã€ã‚’å«ã‚€ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¢ã—ã€ã‚ã‚Œã°ãã®æ™‚é–“ã‚’æ¡ç”¨ã™ã‚‹ã€‚
            // ãªã‘ã‚Œã°ã€é€šå¸¸ã®æ›œæ—¥ï¼ˆæ°´æ›œæ—¥ãªã‚‰ã€Œæ°´ã€ï¼‰ã¨ã—ã¦æŒ¯ã‚‹èˆã†ã€‚

            // å®šä¼‘æ—¥ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ï¼‰
            // â€»ã€Œç¥æ—¥ã¯å–¶æ¥­ã€ãªã©ã®ä¾‹å¤–ãŒã‚ã‚‹ãŸã‚ã€closeæ–‡å­—åˆ—ã«ã€Œç¥ã€ãŒå«ã¾ã‚Œãªã„é™ã‚Šã€
            //   ç¥æ—¥ã¯ä¸€æ—¦å®šä¼‘æ—¥ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ãƒ«ãƒ¼ã—ã¦openãƒ†ã‚­ã‚¹ãƒˆè§£æã«ä»»ã›ã‚‹æˆ¦ç•¥ã‚’ã¨ã‚‹ã€‚
            if (shop.close && shop.close !== 'ãªã—') {
                // ç¥æ—¥ãªã‚‰ã€closeã«ã€Œç¥ã€ãŒå«ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°ã‚»ãƒ¼ãƒ•
                if (isHoliday) {
                    if (shop.close.includes('ç¥') || shop.close.includes('ç¥æ—¥')) return false;
                } else {
                    // å¹³æ—¥ãªã‚‰é€šå¸¸é€šã‚Š
                    if (shop.close.includes(todayDay)) return false;
                }
            }

            // ç¬¬3å±¤: å–¶æ¥­æ™‚é–“ãƒ†ã‚­ã‚¹ãƒˆè§£æ
            // å„ªå…ˆåº¦: ç¥æ—¥(ã‚‚ã—ä»Šæ—¥ãŒç¥æ—¥ãªã‚‰) > é€šå¸¸æ›œæ—¥
            let todayBlock = null;
            if (isHoliday) {
                todayBlock = extractTodayBlock(shop.open, 'ç¥');
            }
            if (!todayBlock) {
                todayBlock = extractTodayBlock(shop.open, todayDay);
            }

            // ä»Šæ—¥ã®ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰æ™‚é–“ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡º
            const targetText = todayBlock || shop.open; // ãƒ–ãƒ­ãƒƒã‚¯ç‰¹å®šã§ããªã‘ã‚Œã°å…¨ä½“
            const timePattern = /(\d{1,2}):(\d{2})\s*[ï½ã€œ~]\s*(?:ç¿Œ)?\s*(\d{1,2}):(\d{2})/g;
            let match;
            let hasTimeData = false;

            while ((match = timePattern.exec(targetText)) !== null) {
                hasTimeData = true;
                let openMin = parseInt(match[1]) * 60 + parseInt(match[2]);
                let closeMin = parseInt(match[3]) * 60 + parseInt(match[4]);

                // æ·±å¤œè·¨ãå¯¾å¿œï¼ˆç¿Œ0:00 ã‚„ 25:00 ãªã©ï¼‰
                if (closeMin <= openMin) closeMin += 24 * 60;
                let checkMin = nowMin;
                if (checkMin < openMin && openMin > 12 * 60) checkMin += 24 * 60;

                if (checkMin >= openMin && checkMin <= closeMin) return true;
            }

            // æ™‚é–“ãƒ‡ãƒ¼ã‚¿ãŒãƒ‘ãƒ¼ã‚¹ã§ããŸ â†’ ç¯„å›²å¤–ãªã®ã§å–¶æ¥­å¤–
            // æ™‚é–“ãƒ‡ãƒ¼ã‚¿ãŒãƒ‘ãƒ¼ã‚¹ã§ããªã‹ã£ãŸ â†’ åˆ¤å®šä¸èƒ½ãªã®ã§é™¤å¤–ï¼ˆå®‰å…¨å´ï¼‰
            return false;
        }

        // æ›œæ—¥ãƒ–ãƒ­ãƒƒã‚¯æŠ½å‡º: "æœˆï½é‡‘: 11:00ï½14:00 ... åœŸ: 18:00ï½22:00" â†’ ä»Šæ—¥ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿”ã™
        function extractTodayBlock(text, today) {
            // æ›œæ—¥ç¯„å›²ãƒ‘ã‚¿ãƒ¼ãƒ³: "æœˆï½é‡‘" "ç«ï½åœŸ" "æœˆï½æ—¥" ãªã© + "ç¥"å¯¾å¿œ
            const dayOrder = 'æœˆç«æ°´æœ¨é‡‘åœŸæ—¥ç¥'; // ç¥ã‚’è¿½åŠ 
            const todayIdx = dayOrder.indexOf(today);
            if (todayIdx === -1) return null; // "ç¥"ä»¥å¤–ã®ä¸æ˜ãªæ–‡å­—

            // ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›œæ—¥ãƒ–ãƒ­ãƒƒã‚¯ã«åˆ†å‰²ï¼ˆã€Œæœˆï½é‡‘ã€ç¥å‰æ—¥:ã€ã®ã‚ˆã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã§åŒºåˆ‡ã‚‹ï¼‰
            // "ç¥"ã‚„"ç¥æ—¥"ã‚‚ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ãŸã‚ã€æ­£è¦è¡¨ç¾ã‚’æ‹¡å¼µ
            const blockPattern = /([æœˆç«æ°´æœ¨é‡‘åœŸæ—¥ç¥](?:[ï½ã€œ~][æœˆç«æ°´æœ¨é‡‘åœŸæ—¥ç¥])?(?:[ã€,][æœˆç«æ°´æœ¨é‡‘åœŸæ—¥ç¥](?:[ï½ã€œ~][æœˆç«æ°´æœ¨é‡‘åœŸæ—¥ç¥])?)*(?:[ã€,](?:ç¥æ—¥|ç¥å‰æ—¥))*)\s*[:ï¼š]/g;
            let blockMatch;
            let bestBlock = null;

            while ((blockMatch = blockPattern.exec(text)) !== null) {
                const daySpec = blockMatch[1];
                if (isDayInSpec(daySpec, today, dayOrder)) {
                    // ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã®é–‹å§‹ä½ç½®ã‹ã‚‰æ¬¡ã®ãƒ–ãƒ­ãƒƒã‚¯ã¾ã§ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
                    const startPos = blockMatch.index + blockMatch[0].length;
                    // æ¬¡ã®ãƒ–ãƒ­ãƒƒã‚¯ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆæœ«å°¾ã¾ã§
                    blockPattern.lastIndex = startPos; // ä¸€æ™‚çš„ã«é€²ã‚ã‚‹
                    const nextMatch = blockPattern.exec(text);
                    const endPos = nextMatch ? nextMatch.index : text.length;
                    blockPattern.lastIndex = startPos; // å…ƒã«æˆ»ã™
                    bestBlock = text.substring(startPos, endPos);
                }
            }
            return bestBlock;
        }

        // æ›œæ—¥æŒ‡å®šã«ä»Šæ—¥ãŒå«ã¾ã‚Œã‚‹ã‹åˆ¤å®š
        function isDayInSpec(spec, today, dayOrder) {
            // "ç¥æ—¥" ã¨ã„ã†æ–‡å­—åˆ—ãŒå«ã¾ã‚Œã¦ã„ã¦ã€todayãŒ "ç¥" ãªã‚‰ãƒ’ãƒƒãƒˆ
            if (today === 'ç¥' && (spec.includes('ç¥æ—¥') || spec.includes('ç¥'))) return true;

            const todayIdx = dayOrder.indexOf(today);
            if (todayIdx === -1) return false;

            // ç¯„å›²æŒ‡å®š: "æœˆï½é‡‘"
            const rangePattern = /([æœˆç«æ°´æœ¨é‡‘åœŸæ—¥])[ï½ã€œ~]([æœˆç«æ°´æœ¨é‡‘åœŸæ—¥])/g;
            let rm;
            while ((rm = rangePattern.exec(spec)) !== null) {
                const startIdx = dayOrder.indexOf(rm[1]);
                const endIdx = dayOrder.indexOf(rm[2]);
                if (startIdx !== -1 && endIdx !== -1) {
                    if (startIdx <= endIdx) {
                        if (todayIdx >= startIdx && todayIdx <= endIdx) return true;
                    } else {
                        // åœŸï½æœˆ ã®ã‚ˆã†ãªè·¨ã
                        if (todayIdx >= startIdx || todayIdx <= endIdx) return true;
                    }
                }
            }
            // å€‹åˆ¥æŒ‡å®š: "åœŸ" "æ—¥"
            if (spec.includes(today)) return true;
            return false;
        }

        // =====================================================================
        //  ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UIåˆæœŸåŒ–
        // =====================================================================
        function initFilterUI() {
            // æ™‚é–“å¸¯ã«ã‚ˆã‚‹ãƒ©ãƒ³ãƒ/ãƒ‡ã‚£ãƒŠãƒ¼è‡ªå‹•é¸æŠ
            // 04:00 ã€œ 15:59 -> ãƒ©ãƒ³ãƒ
            // 16:00 ã€œ 03:59 -> ãƒ‡ã‚£ãƒŠãƒ¼
            const now = new Date();
            const hour = now.getHours();
            const isLunchTime = (hour >= 4 && hour < 16);

            if (isLunchTime) {
                document.querySelector('input[name="time-mode"][value="lunch"]').checked = true;
            } else {
                document.querySelector('input[name="time-mode"][value="dinner"]').checked = true;
            }

            const chipsContainer = document.getElementById('genre-chips');
            const budgetMinSel = document.getElementById('budget-min');
            const budgetMaxSel = document.getElementById('budget-max');
            const filterToggle = document.getElementById('filter-toggle');
            const filterBody = document.getElementById('filter-body');
            const btnResearch = document.getElementById('btn-research');

            // ã‚¸ãƒ£ãƒ³ãƒ«ãƒãƒƒãƒ—ç”Ÿæˆ
            GENRES.forEach(g => {
                const chip = document.createElement('span');
                chip.className = 'genre-chip';
                chip.dataset.code = g.code;
                chip.textContent = `${g.emoji} ${g.name}`;
                chip.addEventListener('click', () => {
                    if (excludedGenres.has(g.code)) {
                        excludedGenres.delete(g.code);
                        chip.classList.remove('excluded');
                    } else {
                        excludedGenres.add(g.code);
                        chip.classList.add('excluded');
                    }
                });
                chipsContainer.appendChild(chip);
            });

            // äºˆç®—ã‚»ãƒ¬ã‚¯ãƒˆç”Ÿæˆï¼ˆé‡‘é¡ãƒ™ãƒ¼ã‚¹ï¼‰
            // é¸æŠè‚¢: 500, 1000, 1500, 2000, 3000, 5000, 10000, 15000, 30000
            const priceOptions = [
                { val: '500', label: '500å††' },
                { val: '1000', label: '1000å††' },
                { val: '1500', label: '1500å††' },
                { val: '2000', label: '2000å††' },
                { val: '3000', label: '3000å††' },
                { val: '4000', label: '4000å††' },
                { val: '5000', label: '5000å††' },
                { val: '7000', label: '7000å††' },
                { val: '10000', label: '10000å††' },
                { val: '15000', label: '15000å††' },
                { val: '20000', label: '20000å††' },
                { val: '30000', label: '30000å††' },
            ];

            priceOptions.forEach(opt => {
                const opt1 = new Option(opt.label, opt.val);
                const opt2 = new Option(opt.label, opt.val);
                budgetMinSel.appendChild(opt1);
                budgetMaxSel.appendChild(opt2);
            });

            // ãƒˆã‚°ãƒ«é–‹é–‰
            filterToggle.addEventListener('click', () => {
                const isOpen = filterBody.style.display !== 'none';
                filterBody.style.display = isOpen ? 'none' : 'block';
                filterToggle.classList.toggle('open', !isOpen);
            });

            // å†æ¤œç´¢ãƒœã‚¿ãƒ³
            btnResearch.addEventListener('click', async () => {
                if (!userLocation && !IS_DEBUG) {
                    statusBar.textContent = 'âš ï¸ ä½ç½®æƒ…å ±ãŒæœªå–å¾—ã§ã™ã€‚';
                    return;
                }

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«åˆ‡ã‚Šæ›¿ãˆ
                btnResearch.disabled = true;
                btnResearch.textContent = 'â³ æ¤œç´¢ä¸­â€¦';
                btnResearch.style.opacity = '0.5';
                btnResearch.style.pointerEvents = 'none';

                try {
                    if (IS_DEBUG) {
                        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¸ãƒ£ãƒ³ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                        choices = choices.filter(c => c.type !== 'shop');
                        const filtered = MOCK_SHOPS.filter(s => !excludedGenres.has(s.genreCode));
                        loadShops(filtered.length > 0 ? filtered : MOCK_SHOPS);
                        renderChoicesUI();
                        drawRoulette();
                        statusBar.textContent = 'ğŸ› ï¸ ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ï¼‰';
                    } else {
                        await searchShops();
                    }
                } finally {
                    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤
                    btnResearch.disabled = false;
                    btnResearch.textContent = 'ğŸ”„ ã“ã®æ¡ä»¶ã§å†æ¤œç´¢';
                    btnResearch.style.opacity = '1';
                    btnResearch.style.pointerEvents = 'auto';
                }
            });
        }

        // =====================================================================
        //  ã‚·ãƒ§ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ©ãƒ³ãƒ€ãƒ 5åº—èˆ—ï¼‰
        // =====================================================================
        function loadShops(allShops) {
            const shuffled = [...allShops].sort(() => Math.random() - 0.5);
            const picked = shuffled.slice(0, Math.min(5, shuffled.length));
            picked.forEach(shop => {
                addChoice(shop.name, 'shop', 5, true, shop);
            });
            return picked.length;
        }

        // =====================================================================
        //  é¸æŠè‚¢ç®¡ç†
        // =====================================================================
        function addChoice(name, type, weight, enabled, data) {
            choices.push({ id: idCounter++, name, type, weight, enabled, data: data || {} });
        }

        function removeChoice(id) {
            choices = choices.filter(c => c.id !== id);
            renderChoicesUI();
            drawRoulette();
        }

        function getEnabledChoices() {
            return choices.filter(c => c.enabled);
        }

        // =====================================================================
        //  UIæ“ä½œåˆ¶å¾¡ï¼ˆãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå›è»¢ä¸­ã®æ“ä½œãƒ–ãƒ­ãƒƒã‚¯ï¼‰
        // =====================================================================
        function updateControlsState(disabled) {
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼éƒ¨ã¨é¸æŠè‚¢ãƒªã‚¹ãƒˆã®æ“ä½œã‚’ç„¡åŠ¹åŒ–
            const filterBody = document.getElementById('filter-body');
            const choicesList = document.getElementById('choices-list');
            const customArea = document.getElementById('custom-input').parentElement; // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã‚¨ãƒªã‚¢

            if (disabled) {
                filterBody.classList.add('opacity-50', 'pointer-events-none');
                choicesList.classList.add('opacity-50', 'pointer-events-none');
                customArea.classList.add('opacity-50', 'pointer-events-none');
            } else {
                filterBody.classList.remove('opacity-50', 'pointer-events-none');
                choicesList.classList.remove('opacity-50', 'pointer-events-none');
                customArea.classList.remove('opacity-50', 'pointer-events-none');
            }
        }

        // =====================================================================
        //  UI: é¸æŠè‚¢ãƒªã‚¹ãƒˆæç”»
        // =====================================================================
        function renderChoicesUI() {
            choicesList.innerHTML = '';
            // åº—èˆ—ã‚’å…ˆã€ã‚«ã‚¹ã‚¿ãƒ ã‚’å¾Œã«è¡¨ç¤º
            const sorted = [...choices].sort((a, b) => (a.type === 'shop' ? 0 : 1) - (b.type === 'shop' ? 0 : 1));
            sorted.forEach((c, i) => {
                const color = PALETTE[i % PALETTE.length];
                const el = document.createElement('div');
                el.className = 'flex items-center gap-3 p-3 bg-gray-50 rounded-xl transition hover:bg-gray-100';

                const emoji = c.type === 'shop' ? 'ğŸ½ï¸' : (c.data.emoji || 'âœ¨');
                const pct = calcPercent(c);

                el.innerHTML = `
        <label class="flex items-center gap-2 cursor-pointer flex-shrink-0">
          <input type="checkbox" data-id="${c.id}" ${c.enabled ? 'checked' : ''}
                 class="w-5 h-5 rounded accent-primary" />
          <span class="w-3 h-3 rounded-full flex-shrink-0" style="background:${color}"></span>
        </label>
        <div class="flex-1 min-w-0">
          ${c.type === 'shop' && c.data.url
                        ? `<a href="${c.data.url}" target="_blank" rel="noopener" class="text-sm font-semibold text-accent truncate block hover:text-orange-600 transition" style="text-decoration:none">${emoji} ${c.name} <span class="text-xs text-gray-400">â†—</span></a>`
                        : `<p class="text-sm font-semibold text-accent truncate">${emoji} ${c.name}</p>`
                    }
          <div class="flex items-center gap-2 mt-1">
            <input type="range" min="1" max="10" value="${c.weight}" data-id="${c.id}"
                   class="flex-1" style="accent-color:${color}" />
            <span class="text-xs font-bold w-12 text-right" style="color:${color}">${pct}%</span>
          </div>
        </div>
        ${c.type === 'custom' ? `<button data-remove="${c.id}" class="text-gray-300 hover:text-red-400 text-lg transition ml-1">âœ•</button>` : ''}
      `;
                choicesList.appendChild(el);
            });

            // ã‚¤ãƒ™ãƒ³ãƒˆ
            choicesList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', e => {
                    const id = parseInt(e.target.dataset.id);
                    const c = choices.find(x => x.id === id);
                    if (c) c.enabled = e.target.checked;
                    renderChoicesUI();
                    drawRoulette();
                });
            });

            choicesList.querySelectorAll('input[type="range"]').forEach(sl => {
                sl.addEventListener('input', e => {
                    const id = parseInt(e.target.dataset.id);
                    const c = choices.find(x => x.id === id);
                    if (c) c.weight = parseInt(e.target.value);
                    // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã®ã¿è»½é‡æ›´æ–°ï¼ˆDOMå…¨å†æ§‹ç¯‰ã—ãªã„ï¼‰
                    choicesList.querySelectorAll('input[type="range"]').forEach(s => {
                        const cid = parseInt(s.dataset.id);
                        const ch = choices.find(x => x.id === cid);
                        if (ch) {
                            const pctEl = s.parentElement.querySelector('span');
                            if (pctEl) pctEl.textContent = calcPercent(ch) + '%';
                        }
                    });
                    requestAnimationFrame(() => drawRoulette());
                });
            });

            choicesList.querySelectorAll('[data-remove]').forEach(btn => {
                btn.addEventListener('click', e => {
                    removeChoice(parseInt(e.target.dataset.remove));
                });
            });
        }

        function calcPercent(choice) {
            const enabled = getEnabledChoices();
            if (!choice.enabled || enabled.length === 0) return 0;
            const total = enabled.reduce((s, c) => s + c.weight, 0);
            return Math.round((choice.weight / total) * 100);
        }

        // =====================================================================
        //  ã‚«ã‚¹ã‚¿ãƒ é¸æŠè‚¢è¿½åŠ 
        // =====================================================================
        btnAdd.addEventListener('click', () => {
            const val = customInput.value.trim();
            if (!val) return;
            addChoice(val, 'custom', 5, true, { emoji: 'ğŸŒŸ' });
            customInput.value = '';
            renderChoicesUI();
            drawRoulette();
        });
        customInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') { e.preventDefault(); btnAdd.click(); }
        });

        // =====================================================================
        //  Canvas ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæç”»
        // =====================================================================
        let currentRotation = 0;

        function drawRoulette(rotation = currentRotation) {
            const enabled = getEnabledChoices();
            ctx.clearRect(0, 0, SIZE, SIZE);
            const cx = SIZE / 2, cy = SIZE / 2, r = SIZE / 2 - 4;

            if (enabled.length === 0) {
                ctx.fillStyle = '#E0E0E0';
                ctx.beginPath();
                ctx.arc(cx, cy, r, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#999';
                ctx.font = '600 14px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('é¸æŠè‚¢ã‚’è¿½åŠ ã—ã¦ãã ã•ã„', cx, cy);
                return;
            }

            const total = enabled.reduce((s, c) => s + c.weight, 0);
            let angle = rotation;

            enabled.forEach((c, i) => {
                const sliceAngle = (c.weight / total) * Math.PI * 2;
                const color = PALETTE[choices.indexOf(c) % PALETTE.length];

                // ã‚»ã‚¯ã‚¿ãƒ¼
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.arc(cx, cy, r, angle, angle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                // ãƒ©ãƒ™ãƒ«
                const mid = angle + sliceAngle / 2;
                const labelR = r * 0.62;
                const lx = cx + Math.cos(mid) * labelR;
                const ly = cy + Math.sin(mid) * labelR;

                ctx.save();
                ctx.translate(lx, ly);
                ctx.rotate(mid + Math.PI / 2);

                const fontSize = sliceAngle > 0.4 ? 12 : sliceAngle > 0.25 ? 10 : 8;
                ctx.font = `700 ${fontSize}px Inter, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#fff';
                ctx.shadowColor = 'rgba(0,0,0,.4)';
                ctx.shadowBlur = 3;

                // åå‰ã‚’çŸ­ç¸®
                let label = c.name.length > 8 ? c.name.slice(0, 7) + 'â€¦' : c.name;
                ctx.fillText(label, 0, 0);

                ctx.restore();
                angle += sliceAngle;
            });

            // ä¸­å¿ƒå††
            ctx.beginPath();
            ctx.arc(cx, cy, 18, 0, Math.PI * 2);
            ctx.fillStyle = '#FFAB40';
            ctx.fill();
            ctx.beginPath();
            ctx.arc(cx, cy, 8, 0, Math.PI * 2);
            ctx.fillStyle = '#fff';
            ctx.fill();
        }

        // =====================================================================
        //  ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        // =====================================================================
        btnStart.addEventListener('click', () => {
            if (spinning) return;
            const enabled = getEnabledChoices();
            if (enabled.length === 0) return;

            spinning = true;
            btnStart.disabled = true;
            updateControlsState(true); // æ“ä½œç„¡åŠ¹åŒ–

            // é‡ã¿ä»˜ãæŠ½é¸ â†’ å½“é¸ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ±ºå®š
            const total = enabled.reduce((s, c) => s + c.weight, 0);
            let rand = Math.random() * total;
            let winnerIdx = 0;
            for (let i = 0; i < enabled.length; i++) {
                rand -= enabled[i].weight;
                if (rand <= 0) { winnerIdx = i; break; }
            }

            // å½“é¸ã‚»ã‚¯ã‚¿ãƒ¼ã®ä¸­å¤®è§’åº¦ã‚’è¨ˆç®—
            let cumAngle = 0;
            for (let i = 0; i < winnerIdx; i++) {
                cumAngle += (enabled[i].weight / total) * Math.PI * 2;
            }
            const winSlice = (enabled[winnerIdx].weight / total) * Math.PI * 2;
            const winMid = cumAngle + winSlice / 2;

            // å›è»¢è¨ˆç®—ã®ä¿®æ­£: ç¾åœ¨ã®å›è»¢è§’(currentRotation)ã‚’è€ƒæ…®ã—ã¦ã€ç›®æ¨™ä½ç½®ã¨æ•´åˆã™ã‚‹ã‚ˆã†ã«è¨ˆç®—
            // ç›®æ¨™: finalRotation + winMid = -Math.PI/2 (mod 2Ï€)
            // ã¤ã¾ã‚Š finalRotation â‰¡ -Math.PI/2 - winMid (mod 2Ï€)
            const baseTarget = -Math.PI / 2 - winMid;

            // æœ€ä½å›è»¢æ•°æ–‡ã‚’ç¢ºä¿ã—ãŸä¸Šã§ã€æ•´åˆã™ã‚‹ k ã‚’æ¢ã™
            const minSpins = 5 + Math.floor(Math.random() * 3); // 5ã€œ7å›è»¢
            const minRotation = currentRotation + minSpins * Math.PI * 2;

            // k ã¯ (minRotation - baseTarget) / 2Ï€ ã®ç¹°ã‚Šä¸Šã’
            const k = Math.ceil((minRotation - baseTarget) / (Math.PI * 2));
            const finalRotation = baseTarget + k * Math.PI * 2;

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®å·®åˆ†è§’åº¦
            const targetAngle = finalRotation - currentRotation;

            const startTime = performance.now();
            const duration = 4000 + Math.random() * 1000; // 4ã€œ5ç§’
            const startRotation = currentRotation;

            function animate(now) {
                const elapsed = now - startTime;
                const t = Math.min(elapsed / duration, 1);
                // ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°: easeOutCubic â†’ æœ€å¾Œã«ã‚†ã£ãã‚Š
                const ease = 1 - Math.pow(1 - t, 3);
                currentRotation = startRotation + targetAngle * ease;

                drawRoulette(currentRotation);

                if (t < 1) {
                    requestAnimationFrame(animate);
                } else {
                    spinning = false;
                    btnStart.disabled = false;
                    updateControlsState(false); // æ“ä½œæœ‰åŠ¹åŒ–
                    showResult(enabled[winnerIdx]);
                }
            }

            requestAnimationFrame(animate);
        });

        // =====================================================================
        //  çµæœè¡¨ç¤º
        // =====================================================================
        function showResult(winner) {
            const titleEl = document.getElementById('result-title');
            const subEl = document.getElementById('result-sub');
            const imgEl = document.getElementById('result-img');
            const actionEl = document.getElementById('result-action');
            const emojiEl = document.getElementById('result-emoji');

            if (winner.type === 'shop') {
                emojiEl.textContent = 'ğŸ‰';
                titleEl.textContent = winner.name;
                subEl.textContent = winner.data.catch || winner.data.genre || 'é‹å‘½ã®ãŠåº—ãŒæ±ºã¾ã‚Šã¾ã—ãŸï¼';

                if (winner.data.photo) {
                    imgEl.src = winner.data.photo;
                    imgEl.classList.remove('hidden');
                } else {
                    imgEl.classList.add('hidden');
                }

                actionEl.textContent = 'ğŸ”¥ ä»Šã™ãäºˆç´„ã™ã‚‹ï¼ˆãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ï¼‰';
                actionEl.href = winner.data.url || 'https://www.hotpepper.jp/';
                actionEl.classList.remove('hidden');

                // ValueCommerce LinkSwitch å‹•çš„ãƒªãƒ³ã‚¯æ›´æ–°ï¼ˆã‚‚ã—ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚Œã°ï¼‰
                // VCDALãŒå‹•çš„ã«hrefå¤‰æ›´ã‚’æ¤œçŸ¥ã—ãªã„å ´åˆã®ä¿é™º
                setTimeout(() => {
                    if (typeof VS !== 'undefined' && VS.LinkSwitch && VS.LinkSwitch.update) {
                        VS.LinkSwitch.update();
                    }
                }, 100);
            } else {
                const emojis = { 'ã‚³ãƒ³ãƒ“ãƒ‹': 'ğŸª', 'è‡ªç‚Š': 'ğŸ³', 'æ–­é£Ÿï¼ˆé£Ÿã¹ãªã„ï¼‰': 'ğŸ§˜' };
                emojiEl.textContent = emojis[winner.name] || winner.data.emoji || 'âœ¨';
                titleEl.textContent = winner.name;

                const messages = {
                    'ã‚³ãƒ³ãƒ“ãƒ‹': 'è¿‘ãã®ã‚³ãƒ³ãƒ“ãƒ‹ã¸GOï¼æ„å¤–ãªæ–°å•†å“ã«å‡ºä¼šãˆã‚‹ã‹ã‚‚ ğŸ›’',
                    'è‡ªç‚Š': 'ä»Šæ—¥ã¯ã‚·ã‚§ãƒ•ãƒ¢ãƒ¼ãƒ‰ç™ºå‹•ï¼å†·è”µåº«ã®ä¸­èº«ã§å¥‡è·¡ã‚’èµ·ã“ãã† ğŸ‘¨â€ğŸ³',
                    'æ–­é£Ÿï¼ˆé£Ÿã¹ãªã„ï¼‰': 'ä¿®è¡Œåƒ§ãƒ¢ãƒ¼ãƒ‰çªå…¥ã€‚ç²¾ç¥ã‚’é›ãˆã‚‹ãƒãƒ£ãƒ³ã‚¹ã§ã™ ğŸ™',
                };
                subEl.textContent = messages[winner.name] || `ã€Œ${winner.name}ã€ã«æ±ºå®šï¼é‹å‘½ã‚’å—ã‘å…¥ã‚Œã‚ˆã† ğŸ²`;

                imgEl.classList.add('hidden');

                if (winner.name === 'è‡ªç‚Š') {
                    actionEl.textContent = 'ğŸ“– ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢ï¼ˆGoogleï¼‰';
                    actionEl.href = 'https://www.google.com/search?q=ç°¡å˜+ãƒ¬ã‚·ãƒ”+ä»Šæ—¥ã®æ™©ã”ã¯ã‚“';
                    actionEl.classList.remove('hidden');
                } else if (winner.name === 'ã‚³ãƒ³ãƒ“ãƒ‹') {
                    actionEl.textContent = 'ğŸ—ºï¸ è¿‘ãã®ã‚³ãƒ³ãƒ“ãƒ‹ã‚’æ¢ã™';
                    actionEl.href = 'https://www.google.com/maps/search/ã‚³ãƒ³ãƒ“ãƒ‹/';
                    actionEl.classList.remove('hidden');
                } else if (winner.name === 'æ–­é£Ÿï¼ˆé£Ÿã¹ãªã„ï¼‰') {
                    actionEl.textContent = 'ğŸ§˜ ç‘æƒ³BGMã‚’è´ã';
                    actionEl.href = 'https://www.youtube.com/results?search_query=ç‘æƒ³+BGM';
                    actionEl.classList.remove('hidden');
                } else {
                    actionEl.textContent = `ğŸ” "${winner.name}" ã‚’æ¤œç´¢`;
                    actionEl.href = `https://www.google.com/search?q=${encodeURIComponent(winner.name)}+è¿‘ã`;
                    actionEl.classList.remove('hidden');
                }
            }

            modal.classList.add('active');
        }

        // ãƒªãƒˆãƒ©ã‚¤
        document.getElementById('btn-retry').addEventListener('click', () => {
            modal.classList.remove('active');
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹
        modal.addEventListener('click', e => {
            if (e.target === modal) modal.classList.remove('active');
        });

        // =====================================================================
        //  èµ·å‹•
        // =====================================================================
        init();

        // =====================================================================
        //  åˆå›è¨ªå•ãƒãƒŠãƒ¼åˆ¶å¾¡
        // =====================================================================
        const guideBanner = document.getElementById('guide-banner');
        if (guideBanner && !localStorage.getItem('guide_banner_closed')) {
            // åˆå›è¨ªå•ï¼ˆã¾ãŸã¯é–‰ã˜ãŸã“ã¨ãŒãªã„å ´åˆï¼‰
            setTimeout(() => {
                guideBanner.classList.remove('translate-y-full', 'opacity-0');
            }, 1000); // 1ç§’é…ã‚ã«è¡¨ç¤º
        }

        function closeGuideBanner() {
            if (!guideBanner) return;
            guideBanner.classList.add('translate-y-full', 'opacity-0');
            localStorage.setItem('guide_banner_closed', 'true');
        }
    </script>
    <!-- ValueCommerce LinkSwitch -->
    <script type="text/javascript" language="javascript">
        var vc_pid = "892542011";
    </script>
    <script type="text/javascript" src="//aml.valuecommerce.com/vcdal.js" async></script>
</body>

<script>
    // Service Worker ç™»éŒ²
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(() => { });
    }
</script>

</html>